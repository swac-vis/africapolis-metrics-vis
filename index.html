<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Metrics Data Visualization</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #FAF9F6;
            color: #2C3E50;
            line-height: 1.5;
        }

        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-sizing: border-box;
        }

        .main-layout {
            display: flex;
            gap: 10px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .left-panel {
            width: 28%;
            min-width: 300px;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
            align-items: stretch;
            flex-shrink: 0;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 0;
            overflow: hidden;
            align-items: stretch;
        }

        .header {
            background: #FFFFFF;
            padding: 8px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(44, 62, 80, 0.08);
            border: 1px solid #E8E6E1;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 2px;
            line-height: 1.2;
            color: #2C3E50;
        }

        .header .subtitle {
            color: #6B7A8A;
            font-size: 11px;
            line-height: 1.2;
        }

        .controls {
            background: #FFFFFF;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(44, 62, 80, 0.08);
            border: 1px solid #E8E6E1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
            flex-shrink: 0;
        }

        .search-filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
        }

        .search-input {
            flex: 1;
            min-width: 120px;
            padding: 5px 8px;
            border: 1px solid #D4D1CA;
            border-radius: 4px;
            font-size: 12px;
            background: #FFFFFF;
            color: #2C3E50;
        }

        .search-input:focus {
            outline: none;
            border-color: #5B8FA3;
            box-shadow: 0 0 0 2px rgba(91, 143, 163, 0.1);
        }

        .country-search-wrapper {
            position: relative;
            flex: 1;
            min-width: 180px;
            max-width: 300px;
        }

        .country-search-input {
            width: 100%;
            padding: 5px 30px 5px 8px;
            border: 1px solid #D4D1CA;
            border-radius: 4px;
            font-size: 12px;
            background: #FFFFFF;
            color: #2C3E50;
        }

        .country-search-input:focus {
            outline: none;
            border-color: #5B8FA3;
            box-shadow: 0 0 0 2px rgba(91, 143, 163, 0.1);
        }

        .country-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #FFFFFF;
            border: 1px solid #D4D1CA;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }

        .country-search-dropdown.show {
            display: block;
        }

        .country-search-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            color: #2C3E50;
            border-bottom: 1px solid #F5F3F0;
        }

        .country-search-item:last-child {
            border-bottom: none;
        }

        .country-search-item:hover {
            background: #F5F3F0;
        }

        .country-search-item.selected {
            background: #E8F0F5;
            color: #5B8FA3;
        }

        .country-search-group {
            border-bottom: 1px solid #E8E6E1;
        }

        .country-search-group:last-child {
            border-bottom: none;
        }

        .country-search-group-header {
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #6B7A8A;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #F5F3F0;
            border-bottom: 1px solid #E8E6E1;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .country-search-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6B7A8A;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .country-search-clear:hover {
            color: #2C3E50;
        }

        .filter-select {
            padding: 5px 8px;
            border: 1px solid #D4D1CA;
            border-radius: 4px;
            font-size: 12px;
            background: #FFFFFF;
            color: #2C3E50;
            min-width: 120px;
            flex-shrink: 0;
        }

        .filter-select:focus {
            outline: none;
            border-color: #5B8FA3;
            box-shadow: 0 0 0 2px rgba(91, 143, 163, 0.1);
        }

        .mode-toggle {
            display: flex;
            gap: 4px;
            background: #F5F3F0;
            border-radius: 4px;
            padding: 2px;
        }

        .mode-toggle-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            background: transparent;
            color: #6B7A8A;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .mode-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            color: #2C3E50;
        }

        .mode-toggle-btn.active {
            background: #FFFFFF;
            color: #5B8FA3;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
            align-items: center;
        }

        .tabs-left-group {
            display: flex;
            gap: 5px;
            align-items: center;
            flex: 1;
        }

        .tabs-right-group {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-left: auto;
        }

        .tab {
            padding: 6px 12px;
            background: #FFFFFF;
            border: 1px solid #D4D1CA;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            color: #2C3E50;
        }

        .tab.active {
            background: #5B8FA3;
            color: #FFFFFF;
            border-color: #5B8FA3;
        }

        .tab:hover:not(.active) {
            background: #F5F3F0;
            border-color: #C4C1BA;
        }

        .metric-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .metric-tab {
            padding: 5px 12px;
            background: #F0EDE8;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            color: #2C3E50;
        }

        .metric-tab.active {
            background: #5B8FA3;
            color: #FFFFFF;
        }

        .metric-tab:hover:not(.active) {
            background: #E8E6E1;
        }

        .data-source-tab {
            padding: 6px 16px;
            background: #E8E6E1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            color: #2C3E50;
            margin-bottom: 10px;
        }

        .data-source-tab.active {
            background: #5B8FA3;
            color: #FFFFFF;
        }

        .data-source-tab:hover:not(.active) {
            background: #D4D1CA;
        }

        .africapolis-tab {
            padding: 5px 12px;
            background: #F0EDE8;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            color: #2C3E50;
        }

        .africapolis-tab.active {
            background: #5B8FA3;
            color: #FFFFFF;
        }

        .africapolis-tab:hover:not(.active) {
            background: #E8E6E1;
        }

        .tab-separator {
            width: 1px;
            background: #D4D1CA;
            margin: 0 5px;
            align-self: stretch;
        }

        .tab-filter-select {
            padding: 5px 8px;
            border: 1px solid #D4D1CA;
            border-radius: 4px;
            font-size: 11px;
            background: #FFFFFF;
            color: #2C3E50;
            cursor: pointer;
            height: fit-content;
            align-self: center;
        }

        .tab-filter-select:focus {
            outline: none;
            border-color: #5B8FA3;
            box-shadow: 0 0 0 2px rgba(91, 143, 163, 0.1);
        }

        .mode-toggle-in-tabs {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .mode-toggle-in-tabs .mode-toggle-btn {
            padding: 5px 10px;
            font-size: 11px;
            border: 1px solid #D4D1CA;
            border-radius: 4px;
            background: #FFFFFF;
            color: #2C3E50;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-toggle-in-tabs .mode-toggle-btn:hover {
            background: #F5F3F0;
        }

        .mode-toggle-in-tabs .mode-toggle-btn.active {
            background: #5B8FA3;
            color: #FFFFFF;
            border-color: #5B8FA3;
        }

        .content-panel {
            background: #FFFFFF;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(44, 62, 80, 0.08);
            border: 1px solid #E8E6E1;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }

        .reference-panel {
            background: #FFFFFF;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(44, 62, 80, 0.08);
            border: 1px solid #E8E6E1;
            flex-shrink: 0;
        }

        .reference-panel-header {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #F5F3F0;
            border-radius: 6px 6px 0 0;
            transition: background 0.2s;
        }

        .reference-panel-header:hover {
            background: #E8E6E1;
        }

        .reference-panel-title {
            font-size: 11px;
            font-weight: 600;
            color: #2C3E50;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .reference-panel-toggle {
            font-size: 10px;
            color: #6B7A8A;
            transition: transform 0.2s;
        }

        .reference-panel.expanded .reference-panel-toggle {
            transform: rotate(180deg);
        }

        .reference-panel-content {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .reference-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .reference-tab {
            padding: 4px 10px;
            background: #F0EDE8;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
            color: #2C3E50;
        }

        .reference-tab.active {
            background: #5B8FA3;
            color: #FFFFFF;
        }

        .reference-tab:hover:not(.active) {
            background: #E8E6E1;
        }

        .reference-content {
            font-size: 11px;
        }
        
        .reference-content .table-header-fixed {
            position: sticky;
            top: 0;
            background: #FFFFFF;
            z-index: 100;
            padding-bottom: 8px;
            margin-bottom: 0;
            border-bottom: 1px solid #E8E6E1;
        }
        
        .reference-content .table-container {
            max-height: calc(400px - 100px);
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
        }
        
        .reference-content .table-container .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #F5F3F0;
        }

        .left-panel .map-section {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .left-panel .map-wrapper {
            flex: 1;
            min-height: 400px;
            width: 100%;
            height: 100%;
            position: relative;
            padding: 0;
            margin: 0;
            border: 1px solid #E8E6E1;
            border-radius: 6px;
            overflow: hidden;
        }

        #mapContainer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        #mapContainer svg {
            width: 100%;
            height: 100%;
            display: block;
            margin: 0;
            padding: 0;
        }

        .visualization-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #E8E6E1;
        }

        .chart-wrapper {
            position: relative;
            height: 250px;
            margin-bottom: 10px;
        }

        .difference-info {
            margin-top: 12px;
            padding: 10px;
            background: #F5F3F0;
            border-radius: 4px;
            border: 1px solid #E8E6E1;
        }

        .difference-info-title {
            font-size: 12px;
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 8px;
        }

        .difference-info-content {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .difference-info-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #FFFFFF;
            border-radius: 3px;
            border: 1px solid #E8E6E1;
            font-size: 11px;
        }

        .difference-info-item-label {
            color: #6B7A8A;
            font-weight: 500;
        }

        .difference-info-item-value {
            color: #2C3E50;
            font-weight: 600;
        }

        .difference-info-item-value.positive {
            color: #5B8FA3;
        }

        .difference-info-item-value.negative {
            color: #D4A574;
        }

        .map-wrapper {
            position: relative;
            width: 100%;
            height: 600px;
            background: #FFFFFF;
            border: 1px solid #E8E6E1;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        /* Map-specific styles when map tab is active */
        body.map-tab-active .map-section {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        body.map-tab-active .map-wrapper {
            height: 100%;
            flex: 1;
            min-height: 400px;
        }

        #mapContainer {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        #mapContainer svg {
            width: 100%;
            height: 100%;
            display: block;
            margin: 0;
            padding: 0;
        }

        #mapContainer .map-group {
            cursor: move;
        }

        #mapContainer .country-path {
            cursor: pointer;
        }

        .map-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            flex-shrink: 0;
        }

        .map-year-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
        }

        .map-year-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #E8E6E1;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .map-year-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #5B8FA3;
            cursor: pointer;
            border: 2px solid #FFFFFF;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .map-year-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #5B8FA3;
            cursor: pointer;
            border: 2px solid #FFFFFF;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .map-year-value {
            min-width: 50px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #2C3E50;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            user-select: none;
        }

        .map-year-value:hover {
            background: #F5F3F0;
        }

        .map-year-select {
            min-width: 50px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #2C3E50;
            padding: 4px 8px;
            border: 1px solid #D4D1CA;
            border-radius: 4px;
            background: #FFFFFF;
            cursor: pointer;
            outline: none;
        }

        .map-year-select:focus {
            border-color: #5B8FA3;
            box-shadow: 0 0 0 2px rgba(91, 143, 163, 0.1);
        }

        .map-play-button {
            padding: 6px 12px;
            background: #5B8FA3;
            color: #FFFFFF;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .map-play-button:hover {
            background: #4A7A8A;
        }

        .map-play-button:active {
            background: #3A6A7A;
        }

        .map-play-button.paused::before {
            content: '▶';
        }

        .map-play-button.playing::before {
            content: '⏸';
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 11px;
            min-width: 180px;
            z-index: 100;
        }

        .map-legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .map-legend-header:hover {
            background: rgba(0,0,0,0.02);
        }

        .map-legend-title {
            font-weight: 500;
            font-size: 11px;
            color: #2C3E50;
        }

        .map-legend-toggle {
            font-size: 10px;
            color: #6B7A8A;
            transition: transform 0.2s;
        }

        .map-legend.collapsed .map-legend-toggle {
            transform: rotate(180deg);
        }

        .map-legend-content {
            padding: 10px;
            display: block;
        }

        .map-legend.collapsed .map-legend-content {
            display: none;
        }

        .map-tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #D4D1CA;
            border-radius: 6px;
            padding: 10px 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: none;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
            min-width: 180px;
        }

        .map-tooltip.visible {
            opacity: 1;
        }

        .map-tooltip-title {
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 8px;
            font-size: 13px;
            border-bottom: 1px solid #E8E6E1;
            padding-bottom: 6px;
        }

        .map-tooltip-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            color: #2C3E50;
        }

        .map-tooltip-item:last-child {
            margin-bottom: 0;
        }

        .map-tooltip-label {
            color: #6B7A8A;
            margin-right: 10px;
        }

        .map-tooltip-value {
            font-weight: 500;
            color: #2C3E50;
        }

        .map-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .map-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }

        .country-path {
            stroke: #FFFFFF;
            stroke-width: 0.5;
            fill-opacity: 0.8;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .country-path:hover {
            stroke-width: 1.5;
            opacity: 0.9;
        }

        .country-path.highlighted {
            stroke: #5B8FA3;
            stroke-width: 2.5;
        }

        .population-circle {
            fill-opacity: 0.6;
            stroke: #FFFFFF;
            stroke-width: 1;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .population-circle:hover {
            fill-opacity: 0.8;
            stroke-width: 2;
        }

        .population-circle.highlighted {
            stroke: #5B8FA3;
            stroke-width: 2.5;
        }

        .chart-wrapper:last-child {
            margin-bottom: 0;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .charts-row .chart-item {
            display: flex;
            flex-direction: column;
        }

        .charts-row .chart-title {
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #333;
        }

        .charts-row .legend {
            margin-bottom: 4px;
        }

        .charts-row .chart-wrapper {
            height: 180px;
            margin-bottom: 0;
        }

        @media (max-width: 1200px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        .chart-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #2C3E50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #333;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .data-table thead {
            background: #F5F3F0;
            position: sticky;
            top: 0;
        }

        .data-table th {
            padding: 5px 6px;
            text-align: left;
            font-weight: 500;
            border-bottom: 2px solid #D4D1CA;
            white-space: nowrap;
            font-size: 11px;
            color: #2C3E50;
        }

        .data-table td {
            padding: 5px 6px;
            border-bottom: 1px solid #E8E6E1;
            font-size: 11px;
            color: #34495E;
            word-wrap: break-word;
        }

        .data-table th.year-highlight,
        .data-table td.year-highlight {
            background-color: #F7FBF9;
            border-left: 2px solid #D4E6DE;
            border-right: 2px solid #D4E6DE;
        }

        .data-table th.year-highlight {
            background-color: #F2F9F6;
            border-bottom: 1px solid #D4E6DE;
        }
        
        #formulasTable td,
        #readmeTable td {
            white-space: normal;
            vertical-align: top;
            max-width: 800px;
        }
        
        #formulasTable th,
        #readmeTable th {
            white-space: normal;
        }

        .data-table tbody tr:hover {
            background: #F5F3F0;
        }

        .size-class-s {
            border-left: 3px solid #6B9B8A;
        }

        .size-class-m {
            border-left: 3px solid #5B8FA3;
        }

        .size-class-l {
            border-left: 3px solid #D4A574;
        }

        .size-class-total {
            border-left: 3px solid #8B9A9F;
        }

        .table-header-fixed {
            position: sticky;
            top: 0;
            background: #FFFFFF;
            z-index: 100;
            padding-bottom: 8px;
            margin-bottom: 0;
            border-bottom: 1px solid #E8E6E1;
        }
        
        .table-header-fixed .chart-title {
            background: #FFFFFF;
            padding-bottom: 6px;
            margin-bottom: 6px;
        }
        
        .table-header-fixed .country-type-selector {
            background: #FFFFFF;
            padding-bottom: 6px;
        }

        .difference-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 6px;
            padding: 6px 0;
            background: #FFFFFF;
            flex-wrap: wrap;
        }

        .difference-controls label {
            font-size: 11px;
            color: #6B7A8A;
            margin-right: 3px;
        }

        .difference-controls select {
            padding: 4px 6px;
            border: 1px solid #D4D1CA;
            border-radius: 4px;
            font-size: 11px;
            background: #FFFFFF;
            color: #2C3E50;
            min-width: 80px;
        }

        .difference-controls select:focus {
            outline: none;
            border-color: #5B8FA3;
            box-shadow: 0 0 0 2px rgba(91, 143, 163, 0.1);
        }

        .difference-controls .difference-label {
            font-size: 11px;
            color: #2C3E50;
            font-weight: 500;
        }

        .data-table .difference-column {
            background-color: #E8F0F5 !important;
            font-weight: 500;
        }

        .data-table th.difference-column {
            background-color: #D4E8F0 !important;
        }

        .table-container {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
        }
        
        .table-container .data-table {
            margin-top: 0;
        }
        
        .table-container .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #F5F3F0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .legend {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .table-filter {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .table-filter-btn {
            padding: 4px 8px;
            background: #F0EDE8;
            border: 1px solid #D4D1CA;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
            color: #2C3E50;
        }

        .table-filter-btn:hover {
            background: #E8E6E1;
            border-color: #C4C1BA;
        }

        .table-filter-btn.active {
            background: #5B8FA3;
            color: #FFFFFF;
            border-color: #5B8FA3;
        }

        .country-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 6px;
            text-transform: uppercase;
        }

        .country-type-country {
            background: #E3F0F4;
            color: #4A7C8F;
        }

        .country-type-region {
            background: #F0E8E3;
            color: #8B6F5E;
        }

        .country-type-continent {
            background: #F5E8D4;
            color: #B8956A;
        }

        .country-type-organization {
            background: #E8F0E8;
            color: #6B9B8A;
        }

        .country-type-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .country-type-selector label {
            font-size: 11px;
            color: #6B7A8A;
            margin-right: 3px;
        }

        .country-type-checkbox {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 10px;
        }

        .country-type-checkbox input[type="checkbox"] {
            margin: 0;
        }

        .table-row-country {
            background: #FAF9F6;
        }

        .table-row-region {
            background: #F5F3F0;
            font-weight: 500;
        }

        .table-row-continent {
            background: #F5E8D4;
            font-weight: 600;
        }

        .table-row-organization {
            background: #F0EDE8;
            font-weight: 500;
        }

        @media (max-width: 1200px) {
            .left-panel {
                width: 30%;
                min-width: 280px;
                max-width: 400px;
            }
        }

        @media (max-width: 992px) {
            .container {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .main-layout {
                flex-direction: column;
                flex: none;
                min-height: 0;
                overflow: visible;
            }

            .left-panel {
                width: 100%;
                max-width: 100%;
                min-width: 0;
                flex-shrink: 0;
            }

            .right-panel {
                width: 100%;
                flex-shrink: 0;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .main-layout {
                flex-direction: column;
                flex: none;
                min-height: 0;
                overflow: visible;
            }

            .controls {
                flex-direction: column;
            }

            .search-input {
                width: 100%;
            }

            .left-panel {
                min-width: 0;
                flex-shrink: 0;
            }

            .right-panel {
                flex-shrink: 0;
            }

            .left-panel .map-wrapper {
                min-height: 300px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .main-layout {
                flex-direction: column;
                flex: none;
                min-height: 0;
                overflow: visible;
            }

            .header h1 {
                font-size: 16px;
            }

            .left-panel {
                flex-shrink: 0;
            }

            .right-panel {
                flex-shrink: 0;
            }

            .left-panel .map-wrapper {
                min-height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Urban Metrics Data Visualization & Analysis System</h1>
            <div class="subtitle">Interactive data visualization and analysis for urban indicators</div>
        </div>

        <div class="main-layout">
            <!-- Left Panel: Map with controls above -->
            <div class="left-panel">
        <div class="controls">
                    <div class="search-filter-group">
                        <div class="country-search-wrapper">
                            <input type="text" id="countrySearchInput" class="country-search-input" 
                                   placeholder="Search country..." autocomplete="off">
                            <button class="country-search-clear" id="countrySearchClear" style="display: none;">×</button>
                            <div class="country-search-dropdown" id="countrySearchDropdown"></div>
                        </div>
            <select id="countryTypeFilter" class="filter-select">
                <option value="">All Types</option>
                <option value="country">Countries Only</option>
                <option value="region">Regions Only</option>
                <option value="continent">Continent Only</option>
                <option value="organization">Regional Entities Only</option>
            </select>
                    </div>
                </div>
                <div class="map-controls">
                    <div class="map-year-slider-container">
                        <label style="font-size: 12px; color: #2C3E50;">Year:</label>
                        <input type="range" id="mapYear" class="map-year-slider" 
                               min="2020" max="2050" step="5" value="2020">
                        <select id="mapYearValue" class="map-year-select">
                            <option value="2020" selected>2020</option>
                            <option value="2025">2025</option>
                            <option value="2030">2030</option>
                            <option value="2035">2035</option>
                            <option value="2040">2040</option>
                            <option value="2045">2045</option>
                            <option value="2050">2050</option>
            </select>
                        <button id="mapPlayButton" class="map-play-button paused" title="Play/Pause"></button>
                    </div>
                </div>
                <div class="map-section">
                    <div class="map-wrapper">
                        <div id="mapContainer"></div>
                        <div class="map-legend expanded" id="mapLegend">
                            <div class="map-legend-header" id="mapLegendHeader">
                                <span class="map-legend-title">Legend</span>
                                <span class="map-legend-toggle">▼</span>
                            </div>
                            <div class="map-legend-content" id="mapLegendContent"></div>
                        </div>
                    </div>
                </div>
        </div>

            <!-- Right Panel: Data -->
            <div class="right-panel">
        <!-- Main Data Source Toggle -->
        <div class="tabs" id="dataSourceTabs">
            <button class="data-source-tab active" data-source="urban-metrics">Urban Metrics Data</button>
            <button class="data-source-tab" data-source="africapolis">Africapolis Raw Data</button>
        </div>

        <!-- Urban Metrics Tabs -->
        <div class="tabs" id="metricTabs">
            <div class="tabs-left-group">
                <button class="metric-tab active" data-metric="population">Population</button>
                <button class="metric-tab" data-metric="area">Area</button>
                <button class="metric-tab" data-metric="count">Count</button>
                <button class="metric-tab" data-metric="growth">Growth</button>
                <button class="metric-tab" data-metric="fusion">Fusion</button>
                <button class="metric-tab" data-metric="absorb">Absorb</button>
            </div>
            <div class="tabs-right-group">
                <div class="tab-separator"></div>
                <select id="sizeClassFilter" class="tab-filter-select">
                    <option value="">All Size Classes</option>
                </select>
                <div class="mode-toggle-in-tabs">
                    <button class="mode-toggle-btn" data-mode="Fixed_Mode" id="fixedModeBtn">Fixed Mode</button>
                    <button class="mode-toggle-btn" data-mode="Moving_Mode" id="movingModeBtn">Moving Mode</button>
                </div>
            </div>
        </div>

        <!-- Africapolis Tabs -->
        <div class="tabs" id="africapolisTabs" style="display: none;">
            <button class="africapolis-tab active" data-africapolis="basic">Basic Info</button>
            <button class="africapolis-tab" data-africapolis="urbanpop">Urban Population</button>
            <button class="africapolis-tab" data-africapolis="totalpop">Total Population</button>
            <button class="africapolis-tab" data-africapolis="mpop">Metropolitan Population</button>
            <button class="africapolis-tab" data-africapolis="urbanlevel">Urban Level</button>
            <button class="africapolis-tab" data-africapolis="usurf">Urban Surface</button>
            <button class="africapolis-tab" data-africapolis="numagglos">Num Agglos</button>
            <button class="africapolis-tab" data-africapolis="adba">Distance between Agglomerations</button>
            <button class="africapolis-tab" data-africapolis="environment">Environment</button>
        </div>

        <div class="content-panel" id="contentPanel">
            <div class="loading">Loading data...</div>
                </div>
                
                <!-- Reference Information Panel (Collapsible) -->
                <div class="reference-panel">
                    <div class="reference-panel-header" id="referencePanelHeader">
                        <span class="reference-panel-title">Reference Information</span>
                        <span class="reference-panel-toggle" id="referencePanelToggle">▼</span>
                    </div>
                    <div class="reference-panel-content" id="referencePanelContent" style="display: none;">
                        <div class="reference-tabs">
                            <button class="reference-tab active" data-ref="formulas">Formulas</button>
                            <button class="reference-tab" data-ref="readme">README</button>
                        </div>
                        <div class="reference-content" id="referenceContent">
                            <div class="loading">Loading reference information...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = {};
        let currentSheet = 'Fixed_Mode';
        let currentMetric = 'population';
        let currentDataSource = 'urban-metrics'; // 'urban-metrics' or 'africapolis'
        let currentAfricapolisTab = 'basic'; // Current Africapolis tab type
        let filteredData = [];
        let charts = {};
        let allCountries = []; // Store all countries for search
        let selectedCountry = ''; // Store selected country code
        let differenceStartYear = '2020'; // Start year for difference calculation
        let differenceEndYear = '2050'; // End year for difference calculation
        let showDifference = false; // Whether to show difference columns
        
        // Country type classification
        const REGIONS = ['North Africa', 'West Africa', 'Central Africa', 'East Africa', 'Southern Africa'];
        const ORGANIZATIONS = [
            'Arab Maghreb Union', 'Common Market of Eastern and Southern Africa',
            'Community of Sahel-Saharan States', 'East African Community',
            'Economic Community of Central African States', 'Economic Community of West African States',
            'Intergovernmental Authority on Development', 'Southern African Development Community',
            'West African Economic and Monetary Union'
        ];
        
        function getCountryType(country) {
            if (!country) return 'country';
            if (country === 'Africa') return 'continent';
            if (REGIONS.includes(country)) return 'region';
            if (ORGANIZATIONS.includes(country)) return 'organization';
            return 'country'; // 3-letter codes are countries
        }

        // Country name to ISO code mapping for GeoJSON
        const COUNTRY_NAME_TO_ISO = {
            'Algeria': 'DZA',
            'Angola': 'AGO',
            'Benin': 'BEN',
            'Botswana': 'BWA',
            'Burkina Faso': 'BFA',
            'Burundi': 'BDI',
            'Cameroon': 'CMR',
            'Cape Verde': 'CPV',
            'Central African Republic': 'CAF',
            'Chad': 'TCD',
            'Comoros': 'COM',
            'Congo': 'COG',
            'Congo (Brazzaville)': 'COG',
            'Congo (Kinshasa)': 'COD',
            'DR Congo': 'COD',
            'Democratic Republic of the Congo': 'COD',
            'D.R. Congo': 'COD',
            'D. R. Congo': 'COD',
            'Republic of the Congo': 'COG',
            'Côte d\'Ivoire': 'CIV',
            'Ivory Coast': 'CIV',
            'Djibouti': 'DJI',
            'Egypt': 'EGY',
            'Equatorial Guinea': 'GNQ',
            'Eritrea': 'ERI',
            'Eswatini': 'SWZ',
            'Swaziland': 'SWZ',
            'Ethiopia': 'ETH',
            'Gabon': 'GAB',
            'Gambia': 'GMB',
            'Ghana': 'GHA',
            'Guinea': 'GIN',
            'Guinea-Bissau': 'GNB',
            'Kenya': 'KEN',
            'Lesotho': 'LSO',
            'Liberia': 'LBR',
            'Libya': 'LBY',
            'Madagascar': 'MDG',
            'Malawi': 'MWI',
            'Mali': 'MLI',
            'Mauritania': 'MRT',
            'Mauritius': 'MUS',
            'Morocco': 'MAR',
            'Mozambique': 'MOZ',
            'Namibia': 'NAM',
            'Niger': 'NER',
            'Nigeria': 'NGA',
            'Rwanda': 'RWA',
            'São Tomé and Príncipe': 'STP',
            'Sao Tome and Principe': 'STP',
            'Senegal': 'SEN',
            'Seychelles': 'SYC',
            'Sierra Leone': 'SLE',
            'Somalia': 'SOM',
            'South Africa': 'ZAF',
            'South Sudan': 'SSD',
            'Sudan': 'SDN',
            'Tanzania': 'TZA',
            'Togo': 'TGO',
            'Tunisia': 'TUN',
            'Uganda': 'UGA',
            'Western Sahara': 'ESH',
            'Zambia': 'ZMB',
            'Zimbabwe': 'ZWE'
        };

        // Create reverse mapping: ISO to Country Name
        const ISO_TO_COUNTRY = {};
        Object.keys(COUNTRY_NAME_TO_ISO).forEach(countryName => {
            const iso = COUNTRY_NAME_TO_ISO[countryName];
            if (!ISO_TO_COUNTRY[iso]) {
                ISO_TO_COUNTRY[iso] = countryName; // Use first occurrence as primary name
            }
        });
        
        // Create a complete list of all country names for search
        // This includes all names from COUNTRY_NAME_TO_ISO mapping
        const ALL_COUNTRY_NAMES = [...new Set(Object.keys(COUNTRY_NAME_TO_ISO))].sort();

        let geoData = null;
        let mapSvg = null;
        let mapProjection = null;
        let mapPath = null;
        let mapZoom = null;
        let mapG = null;
        
        function parseNumberFromCell(text) {
            if (!text) return 0;
            // Remove commas and parse as number
            const cleaned = String(text).replace(/,/g, '');
            return Number(cleaned) || 0;
        }

        // Load Excel file
        window.addEventListener('DOMContentLoaded', function() {
            loadExcelFile();
        });

        function loadExcelFile() {
            // Load first Excel file
            fetch('./urban_metrics_results_100k_1000k.xlsx')
                .then(response => response.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // Read all sheets
                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            allData[sheetName] = XLSX.utils.sheet_to_json(worksheet, {defval: ''});
                        });
                        
                        // Load second Excel file
                        loadAfricapolisCountryFile();
                    };
                    reader.readAsArrayBuffer(blob);
                })
                .catch(err => {
                    document.getElementById('contentPanel').innerHTML = 
                        '<div class="empty-state">Unable to load data file. Please ensure the file exists.</div>';
                    console.error('Error loading file:', err);
                });
        }

        function loadAfricapolisCountryFile() {
            fetch('./Africapolis_country_2025__wENV.xlsx')
                .then(response => response.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        console.log('Africapolis file sheets:', workbook.SheetNames);
                        
                        // Read all sheets with prefix to avoid conflicts
                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            // Use prefix 'Africapolis_' to distinguish from other data
                            const dataKey = 'Africapolis_' + sheetName;
                            allData[dataKey] = XLSX.utils.sheet_to_json(worksheet, {defval: ''});
                            console.log(`Loaded sheet "${sheetName}" as "${dataKey}" with ${allData[dataKey].length} rows`);
                            if (allData[dataKey].length > 0) {
                                console.log(`First row columns:`, Object.keys(allData[dataKey][0]).slice(0, 10));
                            }
                        });
                        
                        initializeApp();
                    };
                    reader.readAsArrayBuffer(blob);
                })
                .catch(err => {
                    console.warn('Error loading Africapolis_country file:', err);
                    // Still initialize app even if this file fails
                    initializeApp();
                });
        }

        function initializeApp() {
            updateFilters();
            applyFilters();
            
            // Initialize map in left panel
            initializeMap();
            
            // Bind events
            // Country search functionality
            const countrySearchInput = document.getElementById('countrySearchInput');
            const countrySearchDropdown = document.getElementById('countrySearchDropdown');
            const countrySearchClear = document.getElementById('countrySearchClear');
            
            function filterCountries(searchTerm) {
                if (!searchTerm) {
                    // Return all items from data (countries, regions, organizations, continent)
                    // Convert ISO codes to country names where possible
                    return allCountries.map(item => {
                        // If item is an ISO code, try to get the country name
                        if (item.length === 3 && /^[A-Z]{3}$/.test(item)) {
                            return ISO_TO_COUNTRY[item] || item;
                        }
                        return item;
                    });
                }
                const term = searchTerm.trim();
                const termLower = term.toLowerCase();
                const termUpper = term.toUpperCase();
                
                // Create a set to avoid duplicates
                const results = new Set();
                
                // Search in allCountries (which contains all types: countries, regions, organizations, continent)
                allCountries.forEach(item => {
                    // If it's an ISO code, check if it matches
                    if (item.length === 3 && /^[A-Z]{3}$/.test(item)) {
                        // Check ISO code match
                        if (item.toUpperCase() === termUpper || item.toUpperCase().includes(termUpper)) {
                            const countryName = ISO_TO_COUNTRY[item];
                            if (countryName) {
                                results.add(countryName);
                            } else {
                                results.add(item);
                            }
                        }
                        // Also check if the country name matches
                        const countryName = ISO_TO_COUNTRY[item];
                        if (countryName && countryName.toLowerCase().includes(termLower)) {
                            results.add(countryName);
                        }
                    } else {
                        // It's a name (country, region, organization, or continent), check if it matches
                        if (item.toLowerCase().includes(termLower)) {
                            results.add(item);
                        }
                    }
                });
                
                // Also search in ALL_COUNTRY_NAMES for additional country name matches
                ALL_COUNTRY_NAMES.forEach(countryName => {
                    const countryLower = countryName.toLowerCase();
                    // Check if country name matches
                    if (countryLower.includes(termLower)) {
                        results.add(countryName);
                    }
                    // Check if ISO code matches
                    const iso = COUNTRY_NAME_TO_ISO[countryName];
                    if (iso) {
                        if (iso.toUpperCase() === termUpper || iso.toUpperCase().includes(termUpper)) {
                            results.add(countryName);
                        }
                    }
                });
                
                return Array.from(results).sort();
            }
            
            function renderCountryDropdown(countries) {
                countrySearchDropdown.innerHTML = '';
                if (countries.length === 0) {
                    countrySearchDropdown.innerHTML = '<div class="country-search-item">No countries found</div>';
                } else {
                    // Group countries by type
                    const groups = {
                        continent: [],
                        region: [],
                        organization: [],
                        country: []
                    };
                    
                    countries.forEach(country => {
                        const type = getCountryType(country);
                        if (groups[type]) {
                            groups[type].push(country);
                        } else {
                            groups.country.push(country);
                        }
                    });
                    
                    // Define group labels
                    const groupLabels = {
                        continent: 'Continent',
                        region: 'Regions',
                        organization: 'Regional Entities',
                        country: 'Countries'
                    };
                    
                    // Render each group
                    ['continent', 'region', 'organization', 'country'].forEach(groupType => {
                        if (groups[groupType].length > 0) {
                            // Create group container
                            const group = document.createElement('div');
                            group.className = 'country-search-group';
                            
                            // Create group header
                            const header = document.createElement('div');
                            header.className = 'country-search-group-header';
                            header.textContent = groupLabels[groupType];
                            group.appendChild(header);
                            
                            // Add items to group
                            groups[groupType].forEach(country => {
                                const item = document.createElement('div');
                                item.className = 'country-search-item';
                                
                                // Get ISO code for this country
                                const iso = COUNTRY_NAME_TO_ISO[country];
                                
                                // Display country name with ISO code
                                const displayText = iso ? `${country} (${iso})` : country;
                                item.textContent = displayText;
                                
                                // Check if this item is selected
                                // For countries with ISO, check ISO code; for others, check name
                                if ((iso && iso === selectedCountry) || (!iso && country === selectedCountry)) {
                                    item.classList.add('selected');
                                }
                                
                                item.addEventListener('click', function() {
                                    // Determine the actual value to use for filtering
                                    // If it's a country with ISO code, use ISO; otherwise use the name as-is
                                    if (iso) {
                                        // It's a country with ISO code, use ISO for filtering
                                        selectedCountry = iso;
                                    } else {
                                        // It's a region, organization, or continent, use the name directly
                                        selectedCountry = country;
                                    }
                                    
                                    countrySearchInput.value = country;
                                    countrySearchDropdown.classList.remove('show');
                                    countrySearchClear.style.display = 'block';
                applyFilters();
                updateVisualizationVisibility();
                                    // Update map highlight (only for countries)
                    const data = allData[currentSheet] || [];
                    const countryData = data.filter(row => getCountryType(row.Country) === 'country');
                                    if (countryData.length > 0 && geoData && iso) {
                        renderMapVisualization(countryData);
                    }
                                });
                                group.appendChild(item);
                            });
                            
                            countrySearchDropdown.appendChild(group);
                        }
                    });
                }
            }
            
            countrySearchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                if (searchTerm) {
                    // Use filterCountries which handles both country names and ISO codes
                    const filtered = filterCountries(searchTerm);
                    renderCountryDropdown(filtered);
                    countrySearchDropdown.classList.add('show');
                    countrySearchClear.style.display = 'block';
                } else {
                    countrySearchDropdown.classList.remove('show');
                    countrySearchClear.style.display = 'none';
                    selectedCountry = '';
                    applyFilters();
                }
            });
            
            countrySearchInput.addEventListener('focus', function() {
                if (this.value) {
                    const filtered = filterCountries(this.value);
                    renderCountryDropdown(filtered);
                    countrySearchDropdown.classList.add('show');
                } else {
                    // Show all items from data (countries, regions, organizations, continent)
                    const allItems = filterCountries('');
                    renderCountryDropdown(allItems);
                    countrySearchDropdown.classList.add('show');
                }
            });
            
            countrySearchClear.addEventListener('click', function(e) {
                e.stopPropagation();
                countrySearchInput.value = '';
                selectedCountry = '';
                this.style.display = 'none';
                countrySearchDropdown.classList.remove('show');
                // Clear map highlights
                clearMapHighlights();
                applyFilters();
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!countrySearchInput.contains(e.target) && !countrySearchDropdown.contains(e.target)) {
                    countrySearchDropdown.classList.remove('show');
                }
            });
            // Main data source toggle
            document.querySelectorAll('.data-source-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Preserve current filter state (especially selectedCountry)
                    const preservedCountry = selectedCountry;
                    const preservedCountryInput = document.getElementById('countrySearchInput').value;
                    
                    document.querySelectorAll('.data-source-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentDataSource = this.dataset.source;
                    
                    if (currentDataSource === 'urban-metrics') {
                        // Show urban metrics tabs, hide africapolis tabs
                        document.getElementById('metricTabs').style.display = 'flex';
                        document.getElementById('africapolisTabs').style.display = 'none';
                        // Show reference information panel (it's for urban metrics)
                        const referencePanel = document.querySelector('.reference-panel');
                        if (referencePanel) {
                            referencePanel.style.display = 'block';
                        }
                        // Reset to first metric if needed
                        if (!['population', 'area', 'count', 'growth', 'fusion', 'absorb'].includes(currentMetric)) {
                            currentMetric = 'population';
                            document.querySelectorAll('.metric-tab').forEach(t => t.classList.remove('active'));
                            document.querySelector('.metric-tab[data-metric="population"]').classList.add('active');
                        }
                    } else {
                        // Show africapolis tabs, hide urban metrics tabs
                        document.getElementById('metricTabs').style.display = 'none';
                        document.getElementById('africapolisTabs').style.display = 'flex';
                        // Hide reference information panel (it's only for urban metrics)
                        const referencePanel = document.querySelector('.reference-panel');
                        if (referencePanel) {
                            referencePanel.style.display = 'none';
                        }
                        currentMetric = 'africapolis';
                    }
                    
                    // Update filters while preserving country filter
                    updateFilters(true);
                    
                    // Restore preserved filter state
                    if (preservedCountry) {
                        selectedCountry = preservedCountry;
                        const countrySearchInput = document.getElementById('countrySearchInput');
                        if (countrySearchInput) {
                            countrySearchInput.value = preservedCountryInput;
                            document.getElementById('countrySearchClear').style.display = 'block';
                        }
                    }
                    
                    applyFilters();
                });
            });

            // Africapolis tabs
            document.querySelectorAll('.africapolis-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.africapolis-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentAfricapolisTab = this.dataset.africapolis;
                    applyFilters();
                });
            });

            document.getElementById('sizeClassFilter').addEventListener('change', function() {
                applyFilters();
                // Update map when size class changes
                const data = allData[currentSheet] || [];
                const countryData = data.filter(row => getCountryType(row.Country) === 'country');
                if (countryData.length > 0 && geoData) {
                    renderMapVisualization(countryData);
                }
            });
            document.getElementById('countryTypeFilter').addEventListener('change', applyFilters);
            // Mode toggle buttons
            const fixedModeBtn = document.getElementById('fixedModeBtn');
            const movingModeBtn = document.getElementById('movingModeBtn');
            
            function updateModeButtons() {
                if (currentSheet === 'Fixed_Mode') {
                    fixedModeBtn.classList.add('active');
                    movingModeBtn.classList.remove('active');
                } else {
                    fixedModeBtn.classList.remove('active');
                    movingModeBtn.classList.add('active');
                }
            }
            
            function updateMetricTabsVisibility() {
                const fusionTab = document.querySelector('.metric-tab[data-metric="fusion"]');
                const absorbTab = document.querySelector('.metric-tab[data-metric="absorb"]');
                
                if (currentSheet === 'Moving_Mode') {
                    // Hide fusion and absorb tabs in Moving Mode
                    if (fusionTab) fusionTab.style.display = 'none';
                    if (absorbTab) absorbTab.style.display = 'none';
                    
                    // If current metric is fusion or absorb, switch to population
                    if (currentMetric === 'fusion' || currentMetric === 'absorb') {
                        currentMetric = 'population';
                        document.querySelectorAll('.metric-tab').forEach(tab => {
                            tab.classList.remove('active');
                            if (tab.dataset.metric === 'population') {
                                tab.classList.add('active');
                            }
                        });
                        applyFilters();
                    }
                } else {
                    // Show fusion and absorb tabs in Fixed Mode
                    if (fusionTab) fusionTab.style.display = '';
                    if (absorbTab) absorbTab.style.display = '';
                }
            }
            
            fixedModeBtn.addEventListener('click', function() {
                // Stop auto-play and reset time to 2020
                if (globalMapPlayInterval) {
                    clearInterval(globalMapPlayInterval);
                    globalMapPlayInterval = null;
                }
                isAutoPlaying = false;
                const yearSlider = document.getElementById('mapYear');
                const yearValue = document.getElementById('mapYearValue');
                const playButton = document.getElementById('mapPlayButton');
                if (yearSlider) yearSlider.value = '2020';
                if (yearValue) yearValue.value = '2020';
                if (playButton) {
                    playButton.classList.remove('playing');
                    playButton.classList.add('paused');
                }
                
                currentSheet = 'Fixed_Mode';
                updateModeButtons();
                updateMetricTabsVisibility();
                updateFilters();
                applyFilters();
                // Reinitialize map with new data
                initializeMap();
            });
            
            movingModeBtn.addEventListener('click', function() {
                // Stop auto-play and reset time to 2020
                if (globalMapPlayInterval) {
                    clearInterval(globalMapPlayInterval);
                    globalMapPlayInterval = null;
                }
                isAutoPlaying = false;
                const yearSlider = document.getElementById('mapYear');
                const yearValue = document.getElementById('mapYearValue');
                const playButton = document.getElementById('mapPlayButton');
                if (yearSlider) yearSlider.value = '2020';
                if (yearValue) yearValue.value = '2020';
                if (playButton) {
                    playButton.classList.remove('playing');
                    playButton.classList.add('paused');
                }
                
                currentSheet = 'Moving_Mode';
                updateModeButtons();
                updateMetricTabsVisibility();
                updateFilters();
                applyFilters();
                // Reinitialize map with new data
                initializeMap();
            });
            
            // Initialize button states
            updateModeButtons();
            updateMetricTabsVisibility();
            
            // Initialize data source display
            if (currentDataSource === 'urban-metrics') {
                document.getElementById('metricTabs').style.display = 'flex';
                document.getElementById('africapolisTabs').style.display = 'none';
                // Show reference information panel
                const referencePanel = document.querySelector('.reference-panel');
                if (referencePanel) {
                    referencePanel.style.display = 'block';
                }
            } else {
                document.getElementById('metricTabs').style.display = 'none';
                document.getElementById('africapolisTabs').style.display = 'flex';
                // Hide reference information panel
                const referencePanel = document.querySelector('.reference-panel');
                if (referencePanel) {
                    referencePanel.style.display = 'none';
                }
            }
            
            // Bind metric tabs (only when urban-metrics is active)
            document.querySelectorAll('.metric-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (currentDataSource !== 'urban-metrics') return;
                    document.querySelectorAll('.metric-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentMetric = this.dataset.metric;
                    applyFilters();
                });
            });
            
            // Bind reference panel toggle
            const referencePanelHeader = document.getElementById('referencePanelHeader');
            const referencePanelContent = document.getElementById('referencePanelContent');
            const referencePanel = referencePanelHeader.closest('.reference-panel');
            let referenceContentLoaded = false;
            
            referencePanelHeader.addEventListener('click', function() {
                const isExpanded = referencePanelContent.style.display !== 'none';
                referencePanelContent.style.display = isExpanded ? 'none' : 'block';
                referencePanel.classList.toggle('expanded', !isExpanded);
                
                // Load content if expanding for the first time
                if (!isExpanded && !referenceContentLoaded) {
                    const activeRefTab = document.querySelector('.reference-tab.active');
                    if (activeRefTab) {
                        const refType = activeRefTab.dataset.ref;
                        if (refType === 'formulas') {
                            renderFormulas();
                        } else if (refType === 'readme') {
                            renderREADME();
                        }
                    }
                    referenceContentLoaded = true;
                }
            });

            // Map legend collapse/expand functionality
            const mapLegendHeader = document.getElementById('mapLegendHeader');
            const mapLegend = document.getElementById('mapLegend');
            if (mapLegendHeader && mapLegend) {
                mapLegendHeader.addEventListener('click', function() {
                    mapLegend.classList.toggle('expanded');
                    mapLegend.classList.toggle('collapsed');
                });
            }
            
            // Bind reference tabs
            document.querySelectorAll('.reference-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.reference-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const refType = this.dataset.ref;
                    if (refType === 'formulas') {
                        renderFormulas();
                    } else if (refType === 'readme') {
                        renderREADME();
                    }
                    referenceContentLoaded = true;
                });
            });
        }

        function updateFilters(preserveCountryFilter = false) {
            // Determine data source based on current data source
            let dataSource = currentSheet;
            if (currentDataSource === 'africapolis') {
                dataSource = 'Africapolis_Country';
            }
            const data = allData[dataSource] || [];
            
            // Update country list for search - combine with Africapolis data if available
            const countries = [...new Set(data.map(row => row.Country).filter(Boolean))];
            if (currentDataSource !== 'africapolis' && allData['Africapolis_Country']) {
                const africapolisCountries = [...new Set(allData['Africapolis_Country'].map(row => row.Country).filter(Boolean))];
                countries.push(...africapolisCountries);
            }
            allCountries = [...new Set(countries)].sort();
            
            // Clear country search only if not preserving filter state
            if (!preserveCountryFilter) {
                const countrySearchInput = document.getElementById('countrySearchInput');
                if (countrySearchInput) {
                    countrySearchInput.value = '';
                    selectedCountry = '';
                    document.getElementById('countrySearchClear').style.display = 'none';
                    document.getElementById('countrySearchDropdown').classList.remove('show');
                }
            }
            
            // Update size class filter - normalize to show unique normalized values
            // For Africapolis data, Size_Class might not exist
            const sizeClassFilter = document.getElementById('sizeClassFilter');
            if (currentDataSource === 'africapolis') {
                // Africapolis data doesn't have Size_Class, so disable the filter
                sizeClassFilter.innerHTML = '<option value="">All Size Classes</option>';
                sizeClassFilter.value = '';
                sizeClassFilter.disabled = true;
            } else {
                sizeClassFilter.disabled = false;
                const sizeClasses = [...new Set(data.map(row => row.Size_Class).filter(Boolean))];
                const normalizedSizeClasses = [...new Set(sizeClasses.map(sc => normalizeSizeClass(sc)))];
                sizeClassFilter.innerHTML = '<option value="">All Size Classes</option>';
                
                // Create options with display names
                const displayNames = {
                    'S': 'S (<100k)',
                    'M': 'M (100k-1M)',
                    'L': 'L (>1M)',
                    'Total': 'Total'
                };
                
                // Add Total if it exists in data
                if (normalizedSizeClasses.includes('Total')) {
                    const totalOption = document.createElement('option');
                    totalOption.value = 'Total';
                    totalOption.textContent = 'Total';
                    sizeClassFilter.appendChild(totalOption);
                }
                
                // Add other size classes
                normalizedSizeClasses.filter(sc => sc !== 'Total').sort().forEach(normalized => {
                    const option = document.createElement('option');
                    option.value = normalized;
                    option.textContent = displayNames[normalized] || normalized;
                    sizeClassFilter.appendChild(option);
                });
                
                // If Total doesn't exist in data, add it anyway for map compatibility
                if (!normalizedSizeClasses.includes('Total')) {
                    const totalOption = document.createElement('option');
                    totalOption.value = 'Total';
                    totalOption.textContent = 'Total';
                    sizeClassFilter.appendChild(totalOption);
                }
                
                // Default to "All Size Classes" (empty value)
                sizeClassFilter.value = '';
            }
        }

        function applyFilters() {
            // Determine data source based on current data source
            let dataSource = currentSheet;
            if (currentDataSource === 'africapolis') {
                dataSource = 'Africapolis_Country';
            }
            const data = allData[dataSource] || [];
            const sizeClassFilter = document.getElementById('sizeClassFilter').value;
            const countryTypeFilter = document.getElementById('countryTypeFilter').value;
            
            filteredData = data.filter(row => {
                const matchCountry = !selectedCountry || row.Country === selectedCountry || row.ISO === selectedCountry;
                // For Africapolis data, Size_Class might not exist
                const matchSizeClassValue = row.Size_Class !== undefined 
                    ? matchSizeClass(row.Size_Class, sizeClassFilter)
                    : true; // If no Size_Class column, always match
                const matchCountryType = !countryTypeFilter || getCountryType(row.Country) === countryTypeFilter;
                return matchCountry && matchSizeClassValue && matchCountryType;
            });
            
            renderContent();
        }
        
        function updateVisualizationVisibility() {
            // Show visualization only when a single country is selected
            const shouldShow = selectedCountry && selectedCountry !== '';
            
            // Update all visualization sections
            const vizSections = document.querySelectorAll('.visualization-section');
            vizSections.forEach(section => {
                if (shouldShow) {
                    section.style.display = 'block';
                    // Trigger chart update for current metric
                    const metricName = section.id.replace('VizSection', '');
                    if (metricName === 'population' && window.updatePopulationChart) {
                        setTimeout(() => window.updatePopulationChart(), 100);
                    } else if (metricName === 'area' && window.updateAreaChart) {
                        setTimeout(() => window.updateAreaChart(), 100);
                    } else if (metricName === 'count' && window.updateCountChart) {
                        setTimeout(() => window.updateCountChart(), 100);
                    } else if (metricName === 'fusion' && window.updateFusionCharts) {
                        setTimeout(() => window.updateFusionCharts(), 100);
                    } else if (metricName === 'absorb' && window.updateAbsorbCharts) {
                        setTimeout(() => window.updateAbsorbCharts(), 100);
                    }
                } else {
                    section.style.display = 'none';
                }
            });
        }

        function renderContent() {
            const panel = document.getElementById('contentPanel');
            
            // Handle map separately
            // Map is now always visible in left panel, no need to render here
            
            // Check data source based on currentDataSource
            if (currentDataSource === 'africapolis') {
                const dataSource = 'Africapolis_Country';
                const data = allData[dataSource] || [];
                if (data.length === 0) {
                    panel.innerHTML = '<div class="empty-state">No Africapolis country data found. Please ensure the file Africapolis_country_2025__wENV.xlsx exists.</div>';
                    return;
                }
                renderAfricapolisCountry();
                return;
            } else if (filteredData.length === 0) {
                panel.innerHTML = '<div class="empty-state">No matching data found</div>';
                return;
            }
            
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') chart.destroy();
            });
            charts = {};
            
            switch(currentMetric) {
                case 'population':
                    renderPopulation();
                    break;
                case 'area':
                    renderArea();
                    break;
                case 'count':
                    renderCount();
                    break;
                case 'growth':
                    renderGrowth();
                    break;
                case 'fusion':
                    renderFusion();
                    break;
                case 'absorb':
                    renderAbsorb();
                    break;
            }
            
            // Update visualization visibility after rendering (only for data metrics)
            if (['population', 'area', 'count', 'fusion', 'absorb'].includes(currentMetric)) {
                setTimeout(() => updateVisualizationVisibility(), 50);
            }
            
            // Highlight year columns after rendering
            const currentYear = document.getElementById('mapYearValue')?.value || document.getElementById('mapYear')?.value || '2020';
            setTimeout(() => highlightYearColumns(currentYear), 100);
        }

        function renderPopulation() {
            const panel = document.getElementById('contentPanel');
            const popCols = Object.keys(filteredData[0])
                .filter(col => col.startsWith('Population_') && !col.includes('Added') && !col.includes('Growth'))
                .sort();
            
            const sizeClasses = ['S (<100k)', 'M (100k-1M)', 'L (>1M)', 'Total'];
            const colors = {
                'S (<100k)': '#6B9B8A',
                'M (100k-1M)': '#5B8FA3',
                'L (>1M)': '#D4A574',
                'Total': '#8B9A9F'
            };
            
            panel.innerHTML = `
                <div class="table-header-fixed">
                <div class="chart-title">Population Data</div>
                <div class="difference-controls" id="populationDifferenceControls">
                    <label>Show Difference:</label>
                    <input type="checkbox" id="populationShowDifference" ${showDifference ? 'checked' : ''}>
                    <label for="populationShowDifference" style="margin-left: 3px;">Enable</label>
                    <span style="margin: 0 8px;">|</span>
                    <label>From:</label>
                    <select id="populationDifferenceStartYear">
                        <option value="2020" ${differenceStartYear === '2020' ? 'selected' : ''}>2020</option>
                        <option value="2025" ${differenceStartYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceStartYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceStartYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceStartYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceStartYear === '2045' ? 'selected' : ''}>2045</option>
                    </select>
                    <label>To:</label>
                    <select id="populationDifferenceEndYear">
                        <option value="2025" ${differenceEndYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceEndYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceEndYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceEndYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceEndYear === '2045' ? 'selected' : ''}>2045</option>
                        <option value="2050" ${differenceEndYear === '2050' ? 'selected' : ''}>2050</option>
                    </select>
                </div>
                <div class="country-type-selector" id="populationTypeSelector">
                    <label>Show:</label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="country" checked> Countries
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="region" checked> Regions
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="continent" checked> Continent
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="organization" checked> Regional Entities
                    </label>
                    </div>
                </div>
                <div class="table-container">
                    ${renderTable(['Country', 'Size_Class', ...popCols], 'populationTable')}
                </div>
                <div class="visualization-section" id="populationVizSection" style="display: none;">
                    <div class="chart-title">Population Trend</div>
                    <div class="legend">
                        ${sizeClasses.map(sc => `
                            <div class="legend-item">
                                <div class="legend-color" style="background: ${colors[sc] || '#666'}"></div>
                                <span>${sc}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="populationChart"></canvas>
                    </div>
                    <div class="difference-info" id="populationDifferenceInfo" style="display: none;">
                        <div class="difference-info-title" id="populationDifferenceInfoTitle">Difference Summary</div>
                        <div class="difference-info-content" id="populationDifferenceInfoContent"></div>
                    </div>
                </div>
            `;
            
            // Bind table filter buttons
            // Bind type selector checkboxes
            const populationTypeSelectorEl = document.getElementById('populationTypeSelector');
            if (populationTypeSelectorEl) {
                populationTypeSelectorEl.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                        filterTableByType('populationTable');
                        if (window.updatePopulationChart) window.updatePopulationChart();
                    }
                });
            }
            
            // Bind difference controls
            const populationShowDifference = document.getElementById('populationShowDifference');
            const populationDifferenceStartYear = document.getElementById('populationDifferenceStartYear');
            const populationDifferenceEndYear = document.getElementById('populationDifferenceEndYear');
            
            if (populationShowDifference) {
                populationShowDifference.addEventListener('change', function() {
                    showDifference = this.checked;
                    differenceStartYear = populationDifferenceStartYear.value;
                    differenceEndYear = populationDifferenceEndYear.value;
                    renderContent();
                    if (showDifference && window.updatePopulationChart) {
                        setTimeout(() => window.updatePopulationChart(), 100);
                    }
                });
            }
            
            if (populationDifferenceStartYear) {
                populationDifferenceStartYear.addEventListener('change', function() {
                    differenceStartYear = this.value;
                    if (showDifference) {
                        renderContent();
                        if (window.updatePopulationChart) {
                            setTimeout(() => window.updatePopulationChart(), 100);
                        }
                    }
                });
            }
            
            if (populationDifferenceEndYear) {
                populationDifferenceEndYear.addEventListener('change', function() {
                    differenceEndYear = this.value;
                    if (showDifference) {
                        renderContent();
                        if (window.updatePopulationChart) {
                            setTimeout(() => window.updatePopulationChart(), 100);
                        }
                    }
                });
            }
            
            // Make updatePopulationChart accessible globally
            window.updatePopulationChart = function() {
                const vizSection = document.getElementById('populationVizSection');
                if (!vizSection || vizSection.style.display === 'none') return;
                
                // Get filtered table data
                const table = document.getElementById('populationTable');
                if (!table) return;
                
                const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
                    .filter(row => row.style.display !== 'none');
                
                if (visibleRows.length === 0) return;
                
                // Group by Size_Class from visible rows
                const datasets = [];
                const dataByClass = {};
                
                visibleRows.forEach(row => {
                    const sizeClass = row.dataset.sizeClass;
                    if (!sizeClass) return;
                    const normalized = normalizeSizeClass(sizeClass);
                    if (!dataByClass[normalized]) {
                        dataByClass[normalized] = [];
                    }
                    dataByClass[normalized].push(row);
                });
                
                sizeClasses.forEach(sizeClass => {
                    const normalized = normalizeSizeClass(sizeClass);
                    const classRows = dataByClass[normalized] || [];
                    if (classRows.length > 0) {
                        const totals = popCols.map(col => {
                            return classRows.reduce((sum, row) => {
                                const cells = row.querySelectorAll('td');
                                const colIndex = ['Country', 'Size_Class', ...popCols].indexOf(col);
                                if (colIndex >= 0 && cells[colIndex]) {
                                    return sum + parseNumberFromCell(cells[colIndex].textContent);
                                }
                                return sum;
                            }, 0);
                        });
                        
                        datasets.push({
                            label: sizeClass,
                            data: totals,
                            borderColor: colors[sizeClass] || '#666',
                            backgroundColor: (colors[sizeClass] || '#666') + '20',
                            tension: 0.4,
                            fill: false
                        });
                    }
                });
                
                if (charts.population) {
                    charts.population.destroy();
                }
                
                const ctx = document.getElementById('populationChart').getContext('2d');
                charts.population = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: popCols.map(col => col.replace('Population_', '')),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + 
                                            Math.round(context.parsed.y).toLocaleString('en-US');
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return Math.round(value).toLocaleString('en-US');
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Update difference info if enabled
                const differenceInfo = document.getElementById('populationDifferenceInfo');
                const differenceInfoContent = document.getElementById('populationDifferenceInfoContent');
                const differenceInfoTitle = document.getElementById('populationDifferenceInfoTitle');
                if (showDifference && differenceInfo && differenceInfoContent) {
                    differenceInfo.style.display = 'block';
                    if (differenceInfoTitle) {
                        differenceInfoTitle.textContent = `Difference Summary (${differenceEndYear} - ${differenceStartYear})`;
                    }
                    
                    // Calculate differences for each size class
                    const differenceItems = [];
                    sizeClasses.forEach(sizeClass => {
                        const normalized = normalizeSizeClass(sizeClass);
                        const classRows = dataByClass[normalized] || [];
                        if (classRows.length > 0) {
                            // Find start and end year columns
                            const startCol = `Population_${differenceStartYear}`;
                            const endCol = `Population_${differenceEndYear}`;
                            const startColIndex = ['Country', 'Size_Class', ...popCols].indexOf(startCol);
                            const endColIndex = ['Country', 'Size_Class', ...popCols].indexOf(endCol);
                            
                            if (startColIndex >= 0 && endColIndex >= 0) {
                                let startTotal = 0;
                                let endTotal = 0;
                                
                                classRows.forEach(row => {
                                    const cells = row.querySelectorAll('td');
                                    if (cells[startColIndex]) {
                                        startTotal += parseNumberFromCell(cells[startColIndex].textContent);
                                    }
                                    if (cells[endColIndex]) {
                                        endTotal += parseNumberFromCell(cells[endColIndex].textContent);
                                    }
                                });
                                
                                const difference = endTotal - startTotal;
                                const displayValue = Math.round(difference).toLocaleString('en-US');
                                const sign = difference > 0 ? '+' : '';
                                const valueClass = difference > 0 ? 'positive' : difference < 0 ? 'negative' : '';
                                
                                differenceItems.push(`
                                    <div class="difference-info-item">
                                        <div class="legend-color" style="background: ${colors[sizeClass] || '#666'}; width: 12px; height: 12px; border-radius: 2px;"></div>
                                        <span class="difference-info-item-label">${sizeClass}:</span>
                                        <span class="difference-info-item-value ${valueClass}">${sign}${displayValue}</span>
                                    </div>
                                `);
                            }
                        }
                    });
                    
                    if (differenceItems.length > 0) {
                        differenceInfoContent.innerHTML = differenceItems.join('');
                    } else {
                        differenceInfo.style.display = 'none';
                    }
                } else if (differenceInfo) {
                    differenceInfo.style.display = 'none';
                }
            }
        }

        function renderArea() {
            const panel = document.getElementById('contentPanel');
            const areaCols = Object.keys(filteredData[0])
                .filter(col => col.startsWith('Area_') && !col.includes('Added') && !col.includes('Growth'))
                .sort();
            
            const sizeClasses = ['S (<100k)', 'M (100k-1M)', 'L (>1M)', 'Total'];
            const colors = {
                'S (<100k)': '#6B9B8A',
                'M (100k-1M)': '#5B8FA3',
                'L (>1M)': '#D4A574',
                'Total': '#8B9A9F'
            };
            
            panel.innerHTML = `
                <div class="table-header-fixed">
                <div class="chart-title">Area Data</div>
                <div class="difference-controls" id="areaDifferenceControls">
                    <label>Show Difference:</label>
                    <input type="checkbox" id="areaShowDifference" ${showDifference ? 'checked' : ''}>
                    <label for="areaShowDifference" style="margin-left: 3px;">Enable</label>
                    <span style="margin: 0 8px;">|</span>
                    <label>From:</label>
                    <select id="areaDifferenceStartYear">
                        <option value="2020" ${differenceStartYear === '2020' ? 'selected' : ''}>2020</option>
                        <option value="2025" ${differenceStartYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceStartYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceStartYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceStartYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceStartYear === '2045' ? 'selected' : ''}>2045</option>
                    </select>
                    <label>To:</label>
                    <select id="areaDifferenceEndYear">
                        <option value="2025" ${differenceEndYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceEndYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceEndYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceEndYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceEndYear === '2045' ? 'selected' : ''}>2045</option>
                        <option value="2050" ${differenceEndYear === '2050' ? 'selected' : ''}>2050</option>
                    </select>
                </div>
                <div class="country-type-selector" id="areaTypeSelector">
                    <label>Show:</label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="country" checked> Countries
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="region" checked> Regions
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="continent" checked> Continent
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="organization" checked> Regional Entities
                    </label>
                    </div>
                </div>
                <div class="table-container">
                    ${renderTable(['Country', 'Size_Class', ...areaCols], 'areaTable')}
                </div>
                <div class="visualization-section" id="areaVizSection" style="display: none;">
                    <div class="chart-title">Area Trend</div>
                    <div class="legend">
                        ${sizeClasses.map(sc => `
                            <div class="legend-item">
                                <div class="legend-color" style="background: ${colors[sc] || '#666'}"></div>
                                <span>${sc}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="areaChart"></canvas>
                    </div>
                    <div class="difference-info" id="areaDifferenceInfo" style="display: none;">
                        <div class="difference-info-title" id="areaDifferenceInfoTitle">Difference Summary</div>
                        <div class="difference-info-content" id="areaDifferenceInfoContent"></div>
                    </div>
                </div>
            `;
            
            // Bind table filter buttons
            // Bind type selector checkboxes
            const areaTypeSelectorEl = document.getElementById('areaTypeSelector');
            if (areaTypeSelectorEl) {
                areaTypeSelectorEl.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                        filterTableByType('areaTable');
                        if (window.updateAreaChart) window.updateAreaChart();
                    }
                });
            }
            
            // Bind difference controls
            const areaShowDifference = document.getElementById('areaShowDifference');
            const areaDifferenceStartYear = document.getElementById('areaDifferenceStartYear');
            const areaDifferenceEndYear = document.getElementById('areaDifferenceEndYear');
            
            if (areaShowDifference) {
                areaShowDifference.addEventListener('change', function() {
                    showDifference = this.checked;
                    differenceStartYear = areaDifferenceStartYear.value;
                    differenceEndYear = areaDifferenceEndYear.value;
                    renderContent();
                    if (showDifference && window.updateAreaChart) {
                        setTimeout(() => window.updateAreaChart(), 100);
                    }
                });
            }
            
            if (areaDifferenceStartYear) {
                areaDifferenceStartYear.addEventListener('change', function() {
                    differenceStartYear = this.value;
                    if (showDifference) {
                        renderContent();
                        if (window.updateAreaChart) {
                            setTimeout(() => window.updateAreaChart(), 100);
                        }
                    }
                });
            }
            
            if (areaDifferenceEndYear) {
                areaDifferenceEndYear.addEventListener('change', function() {
                    differenceEndYear = this.value;
                    if (showDifference) {
                        renderContent();
                        if (window.updateAreaChart) {
                            setTimeout(() => window.updateAreaChart(), 100);
                        }
                    }
                });
            }
            
            // Make updateAreaChart accessible globally
            window.updateAreaChart = function() {
                const vizSection = document.getElementById('areaVizSection');
                if (!vizSection || vizSection.style.display === 'none') return;
                
                const table = document.getElementById('areaTable');
                if (!table) return;
                
                const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
                    .filter(row => row.style.display !== 'none');
                
                if (visibleRows.length === 0) return;
                
                const datasets = [];
                const dataByClass = {};
                
                visibleRows.forEach(row => {
                    const sizeClass = row.dataset.sizeClass;
                    if (!sizeClass) return;
                    const normalized = normalizeSizeClass(sizeClass);
                    if (!dataByClass[normalized]) {
                        dataByClass[normalized] = [];
                    }
                    dataByClass[normalized].push(row);
                });
                
                sizeClasses.forEach(sizeClass => {
                    const normalized = normalizeSizeClass(sizeClass);
                    const classRows = dataByClass[normalized] || [];
                    if (classRows.length > 0) {
                        const totals = areaCols.map(col => {
                            return classRows.reduce((sum, row) => {
                                const cells = row.querySelectorAll('td');
                                const colIndex = ['Country', 'Size_Class', ...areaCols].indexOf(col);
                                if (colIndex >= 0 && cells[colIndex]) {
                                    return sum + parseNumberFromCell(cells[colIndex].textContent);
                                }
                                return sum;
                            }, 0);
                        });
                        
                        datasets.push({
                            label: sizeClass,
                            data: totals,
                            borderColor: colors[sizeClass] || '#666',
                            backgroundColor: (colors[sizeClass] || '#666') + '20',
                            tension: 0.4,
                            fill: false
                        });
                    }
                });
                
                if (charts.area) {
                    charts.area.destroy();
                }
                
                const ctx = document.getElementById('areaChart').getContext('2d');
                charts.area = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: areaCols.map(col => col.replace('Area_', '')),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + 
                                            Math.round(context.parsed.y).toLocaleString('en-US') + ' km²';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return Math.round(value).toLocaleString('en-US');
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Update difference info if enabled
                const differenceInfo = document.getElementById('areaDifferenceInfo');
                const differenceInfoContent = document.getElementById('areaDifferenceInfoContent');
                const differenceInfoTitle = document.getElementById('areaDifferenceInfoTitle');
                if (showDifference && differenceInfo && differenceInfoContent) {
                    differenceInfo.style.display = 'block';
                    if (differenceInfoTitle) {
                        differenceInfoTitle.textContent = `Difference Summary (${differenceEndYear} - ${differenceStartYear})`;
                    }
                    
                    // Calculate differences for each size class
                    const differenceItems = [];
                    sizeClasses.forEach(sizeClass => {
                        const normalized = normalizeSizeClass(sizeClass);
                        const classRows = dataByClass[normalized] || [];
                        if (classRows.length > 0) {
                            // Find start and end year columns
                            const startCol = `Area_${differenceStartYear}`;
                            const endCol = `Area_${differenceEndYear}`;
                            const startColIndex = ['Country', 'Size_Class', ...areaCols].indexOf(startCol);
                            const endColIndex = ['Country', 'Size_Class', ...areaCols].indexOf(endCol);
                            
                            if (startColIndex >= 0 && endColIndex >= 0) {
                                let startTotal = 0;
                                let endTotal = 0;
                                
                                classRows.forEach(row => {
                                    const cells = row.querySelectorAll('td');
                                    if (cells[startColIndex]) {
                                        startTotal += parseNumberFromCell(cells[startColIndex].textContent);
                                    }
                                    if (cells[endColIndex]) {
                                        endTotal += parseNumberFromCell(cells[endColIndex].textContent);
                                    }
                                });
                                
                                const difference = endTotal - startTotal;
                                const displayValue = Math.round(difference).toLocaleString('en-US');
                                const sign = difference > 0 ? '+' : '';
                                const valueClass = difference > 0 ? 'positive' : difference < 0 ? 'negative' : '';
                                
                                differenceItems.push(`
                                    <div class="difference-info-item">
                                        <div class="legend-color" style="background: ${colors[sizeClass] || '#666'}; width: 12px; height: 12px; border-radius: 2px;"></div>
                                        <span class="difference-info-item-label">${sizeClass}:</span>
                                        <span class="difference-info-item-value ${valueClass}">${sign}${displayValue} km²</span>
                                    </div>
                                `);
                            }
                        }
                    });
                    
                    if (differenceItems.length > 0) {
                        differenceInfoContent.innerHTML = differenceItems.join('');
                    } else {
                        differenceInfo.style.display = 'none';
                    }
                } else if (differenceInfo) {
                    differenceInfo.style.display = 'none';
                }
            }
        }

        function renderCount() {
            const panel = document.getElementById('contentPanel');
            const countCols = Object.keys(filteredData[0])
                .filter(col => col.startsWith('Count_') && !col.includes('Added'))
                .sort();
            
            const sizeClasses = ['S (<100k)', 'M (100k-1M)', 'L (>1M)', 'Total'];
            const colors = {
                'S (<100k)': '#6B9B8A',
                'M (100k-1M)': '#5B8FA3',
                'L (>1M)': '#D4A574',
                'Total': '#8B9A9F'
            };
            
            panel.innerHTML = `
                <div class="table-header-fixed">
                <div class="chart-title">Count Data</div>
                <div class="difference-controls" id="countDifferenceControls">
                    <label>Show Difference:</label>
                    <input type="checkbox" id="countShowDifference" ${showDifference ? 'checked' : ''}>
                    <label for="countShowDifference" style="margin-left: 3px;">Enable</label>
                    <span style="margin: 0 8px;">|</span>
                    <label>From:</label>
                    <select id="countDifferenceStartYear">
                        <option value="2020" ${differenceStartYear === '2020' ? 'selected' : ''}>2020</option>
                        <option value="2025" ${differenceStartYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceStartYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceStartYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceStartYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceStartYear === '2045' ? 'selected' : ''}>2045</option>
                    </select>
                    <label>To:</label>
                    <select id="countDifferenceEndYear">
                        <option value="2025" ${differenceEndYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceEndYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceEndYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceEndYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceEndYear === '2045' ? 'selected' : ''}>2045</option>
                        <option value="2050" ${differenceEndYear === '2050' ? 'selected' : ''}>2050</option>
                    </select>
                </div>
                <div class="country-type-selector" id="countTypeSelector">
                    <label>Show:</label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="country" checked> Countries
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="region" checked> Regions
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="continent" checked> Continent
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="organization" checked> Regional Entities
                    </label>
                    </div>
                </div>
                <div class="table-container">
                    ${renderTable(['Country', 'Size_Class', ...countCols], 'countTable')}
                </div>
                <div class="visualization-section" id="countVizSection" style="display: none;">
                    <div class="chart-title">Count Trend</div>
                    <div class="legend">
                        ${sizeClasses.map(sc => `
                            <div class="legend-item">
                                <div class="legend-color" style="background: ${colors[sc] || '#666'}"></div>
                                <span>${sc}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="countChart"></canvas>
                    </div>
                    <div class="difference-info" id="countDifferenceInfo" style="display: none;">
                        <div class="difference-info-title" id="countDifferenceInfoTitle">Difference Summary</div>
                        <div class="difference-info-content" id="countDifferenceInfoContent"></div>
                    </div>
                </div>
            `;
            
            // Bind table filter buttons
            // Bind type selector checkboxes
            const countTypeSelectorEl = document.getElementById('countTypeSelector');
            if (countTypeSelectorEl) {
                countTypeSelectorEl.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                        filterTableByType('countTable');
                        if (window.updateCountChart) window.updateCountChart();
                    }
                });
            }
            
            // Bind difference controls
            const countShowDifference = document.getElementById('countShowDifference');
            const countDifferenceStartYear = document.getElementById('countDifferenceStartYear');
            const countDifferenceEndYear = document.getElementById('countDifferenceEndYear');
            
            if (countShowDifference) {
                countShowDifference.addEventListener('change', function() {
                    showDifference = this.checked;
                    differenceStartYear = countDifferenceStartYear.value;
                    differenceEndYear = countDifferenceEndYear.value;
                    renderContent();
                    if (showDifference && window.updateCountChart) {
                        setTimeout(() => window.updateCountChart(), 100);
                    }
                });
            }
            
            if (countDifferenceStartYear) {
                countDifferenceStartYear.addEventListener('change', function() {
                    differenceStartYear = this.value;
                    if (showDifference) {
                        renderContent();
                        if (window.updateCountChart) {
                            setTimeout(() => window.updateCountChart(), 100);
                        }
                    }
                });
            }
            
            if (countDifferenceEndYear) {
                countDifferenceEndYear.addEventListener('change', function() {
                    differenceEndYear = this.value;
                    if (showDifference) {
                        renderContent();
                        if (window.updateCountChart) {
                            setTimeout(() => window.updateCountChart(), 100);
                        }
                    }
                });
            }
            
            // Make updateCountChart accessible globally
            window.updateCountChart = function() {
                const vizSection = document.getElementById('countVizSection');
                if (!vizSection || vizSection.style.display === 'none') return;
                
                const table = document.getElementById('countTable');
                if (!table) return;
                
                const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
                    .filter(row => row.style.display !== 'none');
                
                if (visibleRows.length === 0) return;
                
                const datasets = [];
                const dataByClass = {};
                
                visibleRows.forEach(row => {
                    const sizeClass = row.dataset.sizeClass;
                    if (!sizeClass) return;
                    const normalized = normalizeSizeClass(sizeClass);
                    if (!dataByClass[normalized]) {
                        dataByClass[normalized] = [];
                    }
                    dataByClass[normalized].push(row);
                });
                
                sizeClasses.forEach(sizeClass => {
                    const normalized = normalizeSizeClass(sizeClass);
                    const classRows = dataByClass[normalized] || [];
                    if (classRows.length > 0) {
                        const totals = countCols.map(col => {
                            return classRows.reduce((sum, row) => {
                                const cells = row.querySelectorAll('td');
                                const colIndex = ['Country', 'Size_Class', ...countCols].indexOf(col);
                                if (colIndex >= 0 && cells[colIndex]) {
                                    return sum + parseNumberFromCell(cells[colIndex].textContent);
                                }
                                return sum;
                            }, 0);
                        });
                        
                        datasets.push({
                            label: sizeClass,
                            data: totals,
                            borderColor: colors[sizeClass] || '#666',
                            backgroundColor: (colors[sizeClass] || '#666') + '20',
                            tension: 0.4,
                            fill: false
                        });
                    }
                });
                
                if (charts.count) {
                    charts.count.destroy();
                }
                
                const ctx = document.getElementById('countChart').getContext('2d');
                charts.count = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: countCols.map(col => col.replace('Count_', '')),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                
                // Update difference info if enabled
                const differenceInfo = document.getElementById('countDifferenceInfo');
                const differenceInfoContent = document.getElementById('countDifferenceInfoContent');
                const differenceInfoTitle = document.getElementById('countDifferenceInfoTitle');
                if (showDifference && differenceInfo && differenceInfoContent) {
                    differenceInfo.style.display = 'block';
                    if (differenceInfoTitle) {
                        differenceInfoTitle.textContent = `Difference Summary (${differenceEndYear} - ${differenceStartYear})`;
                    }
                    
                    // Calculate differences for each size class
                    const differenceItems = [];
                    sizeClasses.forEach(sizeClass => {
                        const normalized = normalizeSizeClass(sizeClass);
                        const classRows = dataByClass[normalized] || [];
                        if (classRows.length > 0) {
                            // Find start and end year columns
                            const startCol = `Count_${differenceStartYear}`;
                            const endCol = `Count_${differenceEndYear}`;
                            const startColIndex = ['Country', 'Size_Class', ...countCols].indexOf(startCol);
                            const endColIndex = ['Country', 'Size_Class', ...countCols].indexOf(endCol);
                            
                            if (startColIndex >= 0 && endColIndex >= 0) {
                                let startTotal = 0;
                                let endTotal = 0;
                                
                                classRows.forEach(row => {
                                    const cells = row.querySelectorAll('td');
                                    if (cells[startColIndex]) {
                                        startTotal += parseNumberFromCell(cells[startColIndex].textContent);
                                    }
                                    if (cells[endColIndex]) {
                                        endTotal += parseNumberFromCell(cells[endColIndex].textContent);
                                    }
                                });
                                
                                const difference = endTotal - startTotal;
                                const displayValue = difference % 1 === 0 ? difference.toString() : difference.toFixed(2);
                                const sign = difference > 0 ? '+' : '';
                                const valueClass = difference > 0 ? 'positive' : difference < 0 ? 'negative' : '';
                                
                                differenceItems.push(`
                                    <div class="difference-info-item">
                                        <div class="legend-color" style="background: ${colors[sizeClass] || '#666'}; width: 12px; height: 12px; border-radius: 2px;"></div>
                                        <span class="difference-info-item-label">${sizeClass}:</span>
                                        <span class="difference-info-item-value ${valueClass}">${sign}${displayValue}</span>
                                    </div>
                                `);
                            }
                        }
                    });
                    
                    if (differenceItems.length > 0) {
                        differenceInfoContent.innerHTML = differenceItems.join('');
                    } else {
                        differenceInfo.style.display = 'none';
                    }
                } else if (differenceInfo) {
                    differenceInfo.style.display = 'none';
                }
            }
        }
        

        function renderGrowth() {
            const panel = document.getElementById('contentPanel');
            const growthCols = Object.keys(filteredData[0])
                .filter(col => col.includes('Growth') || col.includes('Factor') || col.includes('Rate'))
                .sort();
            
            if (growthCols.length === 0) {
                panel.innerHTML = '<div class="empty-state">No growth metrics found in current data</div>';
                return;
            }
            
            panel.innerHTML = `
                <div class="table-header-fixed">
                <div class="chart-title">Growth Metrics Data</div>
                <div class="difference-controls" id="growthDifferenceControls">
                    <label>Show Difference:</label>
                    <input type="checkbox" id="growthShowDifference" ${showDifference ? 'checked' : ''}>
                    <label for="growthShowDifference" style="margin-left: 3px;">Enable</label>
                    <span style="margin: 0 8px;">|</span>
                    <label>From:</label>
                    <select id="growthDifferenceStartYear">
                        <option value="2020" ${differenceStartYear === '2020' ? 'selected' : ''}>2020</option>
                        <option value="2025" ${differenceStartYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceStartYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceStartYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceStartYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceStartYear === '2045' ? 'selected' : ''}>2045</option>
                    </select>
                    <label>To:</label>
                    <select id="growthDifferenceEndYear">
                        <option value="2025" ${differenceEndYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceEndYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceEndYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceEndYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceEndYear === '2045' ? 'selected' : ''}>2045</option>
                        <option value="2050" ${differenceEndYear === '2050' ? 'selected' : ''}>2050</option>
                    </select>
                </div>
                <div class="country-type-selector" id="growthTypeSelector">
                    <label>Show:</label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="country" checked> Countries
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="region" checked> Regions
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="continent" checked> Continent
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="organization" checked> Regional Entities
                    </label>
                    </div>
                </div>
                <div class="table-container">
                    ${renderTable(['Country', 'Size_Class', ...growthCols], 'growthTable')}
                </div>
            `;
            
            // Bind table filter buttons
            // Bind type selector checkboxes
            const growthTypeSelectorEl = document.getElementById('growthTypeSelector');
            if (growthTypeSelectorEl) {
                growthTypeSelectorEl.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                        filterTableByType('growthTable');
                    }
                });
            }
            
            // Bind difference controls
            const growthShowDifference = document.getElementById('growthShowDifference');
            const growthDifferenceStartYear = document.getElementById('growthDifferenceStartYear');
            const growthDifferenceEndYear = document.getElementById('growthDifferenceEndYear');
            
            if (growthShowDifference) {
                growthShowDifference.addEventListener('change', function() {
                    showDifference = this.checked;
                    differenceStartYear = growthDifferenceStartYear.value;
                    differenceEndYear = growthDifferenceEndYear.value;
                    renderContent();
                });
            }
            
            if (growthDifferenceStartYear) {
                growthDifferenceStartYear.addEventListener('change', function() {
                    differenceStartYear = this.value;
                    if (showDifference) {
                        renderContent();
                    }
                });
            }
            
            if (growthDifferenceEndYear) {
                growthDifferenceEndYear.addEventListener('change', function() {
                    differenceEndYear = this.value;
                    if (showDifference) {
                        renderContent();
                    }
                });
            }
        }

        function renderFusion() {
            const panel = document.getElementById('contentPanel');
            const fusionCols = Object.keys(filteredData[0])
                .filter(col => col.toLowerCase().includes('fusion'))
                .sort();
            
            if (fusionCols.length === 0) {
                panel.innerHTML = '<div class="empty-state">No fusion metrics found in current data</div>';
                return;
            }
            
            const sizeClasses = ['S (<100k)', 'M (100k-1M)', 'L (>1M)', 'Total'];
            const colors = {
                'S (<100k)': '#6B9B8A',
                'M (100k-1M)': '#5B8FA3',
                'L (>1M)': '#D4A574',
                'Total': '#8B9A9F'
            };
            
            // Separate columns by type
            const countCols = fusionCols.filter(col => col.toLowerCase().includes('count'));
            const populationCols = fusionCols.filter(col => col.toLowerCase().includes('population'));
            const areaCols = fusionCols.filter(col => col.toLowerCase().includes('area'));
            
            panel.innerHTML = `
                <div class="table-header-fixed">
                <div class="chart-title">Fusion Data</div>
                <div class="difference-controls" id="fusionDifferenceControls">
                    <label>Show Difference:</label>
                    <input type="checkbox" id="fusionShowDifference" ${showDifference ? 'checked' : ''}>
                    <label for="fusionShowDifference" style="margin-left: 3px;">Enable</label>
                    <span style="margin: 0 8px;">|</span>
                    <label>From:</label>
                    <select id="fusionDifferenceStartYear">
                        <option value="2020" ${differenceStartYear === '2020' ? 'selected' : ''}>2020</option>
                        <option value="2025" ${differenceStartYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceStartYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceStartYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceStartYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceStartYear === '2045' ? 'selected' : ''}>2045</option>
                    </select>
                    <label>To:</label>
                    <select id="fusionDifferenceEndYear">
                        <option value="2025" ${differenceEndYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceEndYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceEndYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceEndYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceEndYear === '2045' ? 'selected' : ''}>2045</option>
                        <option value="2050" ${differenceEndYear === '2050' ? 'selected' : ''}>2050</option>
                    </select>
                </div>
                <div class="country-type-selector" id="fusionTypeSelector">
                    <label>Show:</label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="country" checked> Countries
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="region" checked> Regions
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="continent" checked> Continent
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="organization" checked> Regional Entities
                    </label>
                    </div>
                </div>
                <div class="table-container">
                    ${renderTable(['Country', 'Size_Class', ...fusionCols], 'fusionTable')}
                </div>
                <div class="visualization-section" id="fusionVizSection" style="display: none;">
                    <div class="chart-title">Fusion Metrics</div>
                    <div class="charts-row">
                        <div class="chart-item">
                            <div class="chart-title">Count</div>
                            <div class="legend">
                                ${sizeClasses.map(sc => `
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: ${colors[sc] || '#666'}"></div>
                                        <span>${sc}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="fusionCountChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-item">
                            <div class="chart-title">Area (km²)</div>
                            <div class="legend">
                                ${sizeClasses.map(sc => `
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: ${colors[sc] || '#666'}"></div>
                                        <span>${sc}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="fusionAreaChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-item">
                            <div class="chart-title">Population</div>
                            <div class="legend">
                                ${sizeClasses.map(sc => `
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: ${colors[sc] || '#666'}"></div>
                                        <span>${sc}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="fusionPopulationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Bind table filter buttons
            // Bind type selector checkboxes
            const fusionTypeSelectorEl = document.getElementById('fusionTypeSelector');
            if (fusionTypeSelectorEl) {
                fusionTypeSelectorEl.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                        filterTableByType('fusionTable');
                        if (window.updateFusionCharts) window.updateFusionCharts();
                    }
                });
            }
            
            // Bind difference controls
            const fusionShowDifference = document.getElementById('fusionShowDifference');
            const fusionDifferenceStartYear = document.getElementById('fusionDifferenceStartYear');
            const fusionDifferenceEndYear = document.getElementById('fusionDifferenceEndYear');
            
            if (fusionShowDifference) {
                fusionShowDifference.addEventListener('change', function() {
                    showDifference = this.checked;
                    differenceStartYear = fusionDifferenceStartYear.value;
                    differenceEndYear = fusionDifferenceEndYear.value;
                    renderContent();
                });
            }
            
            if (fusionDifferenceStartYear) {
                fusionDifferenceStartYear.addEventListener('change', function() {
                    differenceStartYear = this.value;
                    if (showDifference) {
                        renderContent();
                    }
                });
            }
            
            if (fusionDifferenceEndYear) {
                fusionDifferenceEndYear.addEventListener('change', function() {
                    differenceEndYear = this.value;
                    if (showDifference) {
                        renderContent();
                    }
                });
            }
            
            // Make updateFusionCharts accessible globally
            window.updateFusionCharts = function() {
                const vizSection = document.getElementById('fusionVizSection');
                if (!vizSection || vizSection.style.display === 'none') return;
                
                const table = document.getElementById('fusionTable');
                if (!table) return;
                
                const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
                    .filter(row => row.style.display !== 'none');
                
                if (visibleRows.length === 0) return;
                
                // Get data from visible rows
                const dataByClass = {};
                visibleRows.forEach(row => {
                    const sizeClass = row.dataset.sizeClass;
                    if (!sizeClass) return;
                    const normalized = normalizeSizeClass(sizeClass);
                    if (!dataByClass[normalized]) {
                        dataByClass[normalized] = [];
                    }
                    dataByClass[normalized].push(row);
                });
                
                // Count Chart
                if (countCols.length > 0) {
                    const countDatasets = [];
                    sizeClasses.forEach(sizeClass => {
                        const normalized = normalizeSizeClass(sizeClass);
                        const classRows = dataByClass[normalized] || [];
                        if (classRows.length > 0) {
                            const totals = countCols.map(col => {
                                return classRows.reduce((sum, row) => {
                                    const cells = row.querySelectorAll('td');
                                    const colIndex = ['Country', 'Size_Class', ...fusionCols].indexOf(col);
                                    if (colIndex >= 0 && cells[colIndex]) {
                                        return sum + parseNumberFromCell(cells[colIndex].textContent);
                                    }
                                    return sum;
                                }, 0);
                            });
                            countDatasets.push({
                                label: sizeClass,
                                data: totals,
                                backgroundColor: colors[sizeClass] || '#666',
                                borderColor: colors[sizeClass] || '#666',
                                borderWidth: 1
                            });
                        }
                    });
                    
                    if (charts.fusionCount) charts.fusionCount.destroy();
                    const countCtx = document.getElementById('fusionCountChart').getContext('2d');
                    charts.fusionCount = new Chart(countCtx, {
                        type: 'bar',
                        data: {
                            labels: countCols.map(col => col.replace('Fusioned agglos by 2050 (total count)', 'Count')),
                            datasets: countDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: {
                                x: { stacked: false },
                                y: { beginAtZero: true, ticks: { stepSize: 1 } }
                            }
                        }
                    });
                }
                
                // Area Chart
                if (areaCols.length > 0) {
                    const areaDatasets = [];
                    sizeClasses.forEach(sizeClass => {
                        const normalized = normalizeSizeClass(sizeClass);
                        const classRows = dataByClass[normalized] || [];
                        if (classRows.length > 0) {
                            const totals = areaCols.map(col => {
                                return classRows.reduce((sum, row) => {
                                    const cells = row.querySelectorAll('td');
                                    const colIndex = ['Country', 'Size_Class', ...fusionCols].indexOf(col);
                                    if (colIndex >= 0 && cells[colIndex]) {
                                        return sum + parseNumberFromCell(cells[colIndex].textContent);
                                    }
                                    return sum;
                                }, 0);
                            });
                            areaDatasets.push({
                                label: sizeClass,
                                data: totals,
                                backgroundColor: colors[sizeClass] || '#666',
                                borderColor: colors[sizeClass] || '#666',
                                borderWidth: 1
                            });
                        }
                    });
                    
                    if (charts.fusionArea) charts.fusionArea.destroy();
                    const areaCtx = document.getElementById('fusionAreaChart').getContext('2d');
                    charts.fusionArea = new Chart(areaCtx, {
                        type: 'bar',
                        data: {
                            labels: areaCols.map(col => col.replace('Fusioned area (km2) by 2050', 'Area (km²)')),
                            datasets: areaDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + 
                                                Math.round(context.parsed.y).toLocaleString('en-US') + ' km²';
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { stacked: false },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return Math.round(value).toLocaleString('en-US');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Population Chart
                if (populationCols.length > 0) {
                    const populationDatasets = [];
                    sizeClasses.forEach(sizeClass => {
                        const normalized = normalizeSizeClass(sizeClass);
                        const classRows = dataByClass[normalized] || [];
                        if (classRows.length > 0) {
                            const totals = populationCols.map(col => {
                                return classRows.reduce((sum, row) => {
                                    const cells = row.querySelectorAll('td');
                                    const colIndex = ['Country', 'Size_Class', ...fusionCols].indexOf(col);
                                    if (colIndex >= 0 && cells[colIndex]) {
                                        return sum + parseNumberFromCell(cells[colIndex].textContent);
                                    }
                                    return sum;
                                }, 0);
                            });
                            populationDatasets.push({
                                label: sizeClass,
                                data: totals,
                                backgroundColor: colors[sizeClass] || '#666',
                                borderColor: colors[sizeClass] || '#666',
                                borderWidth: 1
                            });
                        }
                    });
                    
                    if (charts.fusionPopulation) charts.fusionPopulation.destroy();
                    const popCtx = document.getElementById('fusionPopulationChart').getContext('2d');
                    charts.fusionPopulation = new Chart(popCtx, {
                        type: 'bar',
                        data: {
                            labels: populationCols.map(col => col.replace('Fusioned population by 2050', 'Population')),
                            datasets: populationDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + 
                                                Math.round(context.parsed.y).toLocaleString('en-US');
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { stacked: false },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return Math.round(value).toLocaleString('en-US');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }

        function renderAbsorb() {
            const panel = document.getElementById('contentPanel');
            const absorbCols = Object.keys(filteredData[0])
                .filter(col => col.toLowerCase().includes('absorb'))
                .sort();
            
            if (absorbCols.length === 0) {
                panel.innerHTML = '<div class="empty-state">No absorb metrics found in current data</div>';
                return;
            }
            
            const sizeClasses = ['S (<100k)', 'M (100k-1M)', 'L (>1M)', 'Total'];
            const colors = {
                'S (<100k)': '#6B9B8A',
                'M (100k-1M)': '#5B8FA3',
                'L (>1M)': '#D4A574',
                'Total': '#8B9A9F'
            };
            
            // Separate columns by type
            const absorbCountCols = absorbCols.filter(col => col.toLowerCase().includes('count'));
            const absorbPopulationCols = absorbCols.filter(col => col.toLowerCase().includes('population'));
            const absorbAreaCols = absorbCols.filter(col => col.toLowerCase().includes('area'));
            
            panel.innerHTML = `
                <div class="table-header-fixed">
                <div class="chart-title">Absorb Data</div>
                <div class="difference-controls" id="absorbDifferenceControls">
                    <label>Show Difference:</label>
                    <input type="checkbox" id="absorbShowDifference" ${showDifference ? 'checked' : ''}>
                    <label for="absorbShowDifference" style="margin-left: 3px;">Enable</label>
                    <span style="margin: 0 8px;">|</span>
                    <label>From:</label>
                    <select id="absorbDifferenceStartYear">
                        <option value="2020" ${differenceStartYear === '2020' ? 'selected' : ''}>2020</option>
                        <option value="2025" ${differenceStartYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceStartYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceStartYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceStartYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceStartYear === '2045' ? 'selected' : ''}>2045</option>
                    </select>
                    <label>To:</label>
                    <select id="absorbDifferenceEndYear">
                        <option value="2025" ${differenceEndYear === '2025' ? 'selected' : ''}>2025</option>
                        <option value="2030" ${differenceEndYear === '2030' ? 'selected' : ''}>2030</option>
                        <option value="2035" ${differenceEndYear === '2035' ? 'selected' : ''}>2035</option>
                        <option value="2040" ${differenceEndYear === '2040' ? 'selected' : ''}>2040</option>
                        <option value="2045" ${differenceEndYear === '2045' ? 'selected' : ''}>2045</option>
                        <option value="2050" ${differenceEndYear === '2050' ? 'selected' : ''}>2050</option>
                    </select>
                </div>
                <div class="country-type-selector" id="absorbTypeSelector">
                    <label>Show:</label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="country" checked> Countries
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="region" checked> Regions
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="continent" checked> Continent
                    </label>
                    <label class="country-type-checkbox">
                        <input type="checkbox" data-type="organization" checked> Regional Entities
                    </label>
                    </div>
                </div>
                <div class="table-container">
                    ${renderTable(['Country', 'Size_Class', ...absorbCols], 'absorbTable')}
                </div>
                <div class="visualization-section" id="absorbVizSection" style="display: none;">
                    <div class="chart-title">Absorb Metrics</div>
                    <div class="charts-row">
                        <div class="chart-item">
                            <div class="chart-title">Count</div>
                            <div class="legend">
                                ${sizeClasses.map(sc => `
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: ${colors[sc] || '#666'}"></div>
                                        <span>${sc}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="absorbCountChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-item">
                            <div class="chart-title">Area (km²)</div>
                            <div class="legend">
                                ${sizeClasses.map(sc => `
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: ${colors[sc] || '#666'}"></div>
                                        <span>${sc}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="absorbAreaChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-item">
                            <div class="chart-title">Population</div>
                            <div class="legend">
                                ${sizeClasses.map(sc => `
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: ${colors[sc] || '#666'}"></div>
                                        <span>${sc}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="absorbPopulationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Bind table filter buttons
            // Bind type selector checkboxes
            const absorbTypeSelectorEl = document.getElementById('absorbTypeSelector');
            if (absorbTypeSelectorEl) {
                absorbTypeSelectorEl.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                        filterTableByType('absorbTable');
                        if (window.updateAbsorbCharts) window.updateAbsorbCharts();
                    }
                });
            }
            
            // Bind difference controls
            const absorbShowDifference = document.getElementById('absorbShowDifference');
            const absorbDifferenceStartYear = document.getElementById('absorbDifferenceStartYear');
            const absorbDifferenceEndYear = document.getElementById('absorbDifferenceEndYear');
            
            if (absorbShowDifference) {
                absorbShowDifference.addEventListener('change', function() {
                    showDifference = this.checked;
                    differenceStartYear = absorbDifferenceStartYear.value;
                    differenceEndYear = absorbDifferenceEndYear.value;
                    renderContent();
                });
            }
            
            if (absorbDifferenceStartYear) {
                absorbDifferenceStartYear.addEventListener('change', function() {
                    differenceStartYear = this.value;
                    if (showDifference) {
                        renderContent();
                    }
                });
            }
            
            if (absorbDifferenceEndYear) {
                absorbDifferenceEndYear.addEventListener('change', function() {
                    differenceEndYear = this.value;
                    if (showDifference) {
                        renderContent();
                    }
                });
            }
            
            // Make updateAbsorbCharts accessible globally
            window.updateAbsorbCharts = function() {
                const vizSection = document.getElementById('absorbVizSection');
                if (!vizSection || vizSection.style.display === 'none') return;
                
                const table = document.getElementById('absorbTable');
                if (!table) return;
                
                const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
                    .filter(row => row.style.display !== 'none');
                
                if (visibleRows.length === 0) return;
                
                // Get data from visible rows
                const dataByClass = {};
                visibleRows.forEach(row => {
                    const sizeClass = row.dataset.sizeClass;
                    if (!sizeClass) return;
                    const normalized = normalizeSizeClass(sizeClass);
                    if (!dataByClass[normalized]) {
                        dataByClass[normalized] = [];
                    }
                    dataByClass[normalized].push(row);
                });
                
                // Count Chart
                if (absorbCountCols.length > 0) {
                    const countDatasets = [];
                    sizeClasses.forEach(sizeClass => {
                        const normalized = normalizeSizeClass(sizeClass);
                        const classRows = dataByClass[normalized] || [];
                        if (classRows.length > 0) {
                            const totals = absorbCountCols.map(col => {
                                return classRows.reduce((sum, row) => {
                                    const cells = row.querySelectorAll('td');
                                    const colIndex = ['Country', 'Size_Class', ...absorbCols].indexOf(col);
                                    if (colIndex >= 0 && cells[colIndex]) {
                                        return sum + parseNumberFromCell(cells[colIndex].textContent);
                                    }
                                    return sum;
                                }, 0);
                            });
                            countDatasets.push({
                                label: sizeClass,
                                data: totals,
                                backgroundColor: colors[sizeClass] || '#666',
                                borderColor: colors[sizeClass] || '#666',
                                borderWidth: 1
                            });
                        }
                    });
                    
                    if (charts.absorbCount) charts.absorbCount.destroy();
                    const countCtx = document.getElementById('absorbCountChart').getContext('2d');
                    charts.absorbCount = new Chart(countCtx, {
                        type: 'bar',
                        data: {
                            labels: absorbCountCols.map(col => col.replace('Absorbed rural agglos by 2050 (total count)', 'Count')),
                            datasets: countDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: {
                                x: { stacked: false },
                                y: { beginAtZero: true, ticks: { stepSize: 1 } }
                            }
                        }
                    });
                }
                
                // Area Chart
                if (absorbAreaCols.length > 0) {
                    const areaDatasets = [];
                    sizeClasses.forEach(sizeClass => {
                        const normalized = normalizeSizeClass(sizeClass);
                        const classRows = dataByClass[normalized] || [];
                        if (classRows.length > 0) {
                            const totals = absorbAreaCols.map(col => {
                                return classRows.reduce((sum, row) => {
                                    const cells = row.querySelectorAll('td');
                                    const colIndex = ['Country', 'Size_Class', ...absorbCols].indexOf(col);
                                    if (colIndex >= 0 && cells[colIndex]) {
                                        return sum + parseNumberFromCell(cells[colIndex].textContent);
                                    }
                                    return sum;
                                }, 0);
                            });
                            areaDatasets.push({
                                label: sizeClass,
                                data: totals,
                                backgroundColor: colors[sizeClass] || '#666',
                                borderColor: colors[sizeClass] || '#666',
                                borderWidth: 1
                            });
                        }
                    });
                    
                    if (charts.absorbArea) charts.absorbArea.destroy();
                    const areaCtx = document.getElementById('absorbAreaChart').getContext('2d');
                    charts.absorbArea = new Chart(areaCtx, {
                        type: 'bar',
                        data: {
                            labels: absorbAreaCols.map(col => col.replace('Absorbed area (km2) by 2050', 'Area (km²)')),
                            datasets: areaDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + 
                                                Math.round(context.parsed.y).toLocaleString('en-US') + ' km²';
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { stacked: false },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return Math.round(value).toLocaleString('en-US');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Population Chart
                if (absorbPopulationCols.length > 0) {
                    const populationDatasets = [];
                    sizeClasses.forEach(sizeClass => {
                        const normalized = normalizeSizeClass(sizeClass);
                        const classRows = dataByClass[normalized] || [];
                        if (classRows.length > 0) {
                            const totals = absorbPopulationCols.map(col => {
                                return classRows.reduce((sum, row) => {
                                    const cells = row.querySelectorAll('td');
                                    const colIndex = ['Country', 'Size_Class', ...absorbCols].indexOf(col);
                                    if (colIndex >= 0 && cells[colIndex]) {
                                        return sum + parseNumberFromCell(cells[colIndex].textContent);
                                    }
                                    return sum;
                                }, 0);
                            });
                            populationDatasets.push({
                                label: sizeClass,
                                data: totals,
                                backgroundColor: colors[sizeClass] || '#666',
                                borderColor: colors[sizeClass] || '#666',
                                borderWidth: 1
                            });
                        }
                    });
                    
                    if (charts.absorbPopulation) charts.absorbPopulation.destroy();
                    const popCtx = document.getElementById('absorbPopulationChart').getContext('2d');
                    charts.absorbPopulation = new Chart(popCtx, {
                        type: 'bar',
                        data: {
                            labels: absorbPopulationCols.map(col => col.replace('Absorbed population by 2050', 'Population')),
                            datasets: populationDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + 
                                                Math.round(context.parsed.y).toLocaleString('en-US');
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { stacked: false },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return Math.round(value).toLocaleString('en-US');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }

        function renderAfricapolisCountry() {
            const panel = document.getElementById('contentPanel');
            
            // Get data directly from allData if filteredData is empty
            const dataSource = 'Africapolis_Country';
            let dataToUse = filteredData.length > 0 ? filteredData : (allData[dataSource] || []);
            
            if (dataToUse.length === 0) {
                panel.innerHTML = '<div class="empty-state">No Africapolis country data found. Please ensure the file Africapolis_country_2025__wENV.xlsx exists.</div>';
                return;
            }
            
            // Get all columns from the first row (keep original names with spaces)
            const allColumnsOriginal = Object.keys(dataToUse[0]);
            
            // Create a mapping from trimmed names to original names
            const columnNameMap = {};
            allColumnsOriginal.forEach(origCol => {
                const trimmed = origCol.trim();
                if (!columnNameMap[trimmed]) {
                    columnNameMap[trimmed] = origCol;
                }
            });
            
            // Use trimmed column names for matching
            const allColumns = allColumnsOriginal.map(col => col.trim());
            
            // Debug: log available columns
            console.log('Africapolis data columns:', allColumns.slice(0, 20));
            console.log('Data rows count:', dataToUse.length);
            
            // Organize columns into groups (case-insensitive matching)
            // Map back to original column names (with spaces) for data access
            const basicCols = ['ISO', 'Country', 'Country_FR', 'AU_Regions', 'Area'];
            const urbanPopCols = allColumns.filter(col => {
                const colUpper = col.toUpperCase();
                return colUpper.startsWith('UPOP');
            }).map(col => columnNameMap[col] || col).sort();
            const totalPopCols = allColumns.filter(col => {
                const colUpper = col.toUpperCase();
                return colUpper.startsWith('TPOP');
            }).map(col => columnNameMap[col] || col).sort();
            const urbanLevelCols = allColumns.filter(col => {
                const colUpper = col.toUpperCase();
                return colUpper.startsWith('URBANLEVEL');
            }).map(col => columnNameMap[col] || col).sort();
            const usurfCols = allColumns.filter(col => {
                const colUpper = col.toUpperCase();
                return colUpper.startsWith('USURF');
            }).map(col => columnNameMap[col] || col).sort();
            const numAgglosCols = allColumns.filter(col => {
                const colUpper = col.toUpperCase();
                return colUpper.startsWith('NUMAGGLOS');
            }).map(col => columnNameMap[col] || col).sort();
            const mpopCols = allColumns.filter(col => {
                const colUpper = col.toUpperCase();
                return colUpper.startsWith('MPOP');
            }).map(col => columnNameMap[col] || col).sort();
            const adbaCols = allColumns.filter(col => {
                const colUpper = col.toUpperCase();
                return colUpper.startsWith('ADBA');
            }).map(col => columnNameMap[col] || col).sort();
            
            // Debug: log found columns
            console.log('Urban Pop columns found:', urbanPopCols);
            console.log('Total Pop columns found:', totalPopCols);
            console.log('Urban Surface columns found:', usurfCols);
            const envCols = allColumns.filter(col => {
                const colUpper = col.toUpperCase();
                return colUpper.includes('TREE_COVER') || colUpper.includes('SHRUBLAND_COVER') || 
                       colUpper.includes('GRASSLAND_COVER') || colUpper.includes('URBAN_GREEN_SPACE') ||
                       colUpper.includes('SPRAWL') || colUpper.includes('ELONGATION') || 
                       colUpper.includes('STREET_LENGTH') || colUpper.includes('INT_DENSITY') ||
                       colUpper.includes('PM2.5') || colUpper.includes('TOTALFOOTPRINT');
            }).map(col => columnNameMap[col] || col).sort();
            
            // Debug: log found environment columns
            console.log('Environment columns found:', envCols);
            
            // Determine which columns to display based on currentAfricapolisTab
            let displayColumns = [];
            let tableTitle = 'Africapolis Country Data';
            
            // Helper function to get original column name (with spaces)
            const getOriginalColName = (colName) => {
                return columnNameMap[colName.trim()] || colName;
            };
            
            switch(currentAfricapolisTab) {
                case 'basic':
                    displayColumns = basicCols.map(col => getOriginalColName(col)).filter(col => allColumnsOriginal.includes(col));
                    tableTitle = 'Africapolis Country Data - Basic Information';
                    break;
                case 'urbanpop':
                    if (urbanPopCols.length === 0) {
                        panel.innerHTML = '<div class="empty-state">No Urban Population columns found in data</div>';
                        return;
                    }
                    displayColumns = [getOriginalColName('ISO'), getOriginalColName('Country'), ...urbanPopCols];
                    tableTitle = 'Africapolis Country Data - Urban Population';
                    break;
                case 'totalpop':
                    if (totalPopCols.length === 0) {
                        panel.innerHTML = '<div class="empty-state">No Total Population columns found in data</div>';
                        return;
                    }
                    displayColumns = [getOriginalColName('ISO'), getOriginalColName('Country'), ...totalPopCols];
                    tableTitle = 'Africapolis Country Data - Total Population';
                    break;
                case 'urbanlevel':
                    if (urbanLevelCols.length === 0) {
                        panel.innerHTML = '<div class="empty-state">No Urban Level columns found in data</div>';
                        return;
                    }
                    displayColumns = [getOriginalColName('ISO'), getOriginalColName('Country'), ...urbanLevelCols];
                    tableTitle = 'Africapolis Country Data - Urban Level';
                    break;
                case 'usurf':
                    if (usurfCols.length === 0) {
                        panel.innerHTML = '<div class="empty-state">No Urban Surface columns found in data</div>';
                        return;
                    }
                    displayColumns = [getOriginalColName('ISO'), getOriginalColName('Country'), ...usurfCols];
                    tableTitle = 'Africapolis Country Data - Urban Surface';
                    break;
                case 'numagglos':
                    if (numAgglosCols.length === 0) {
                        panel.innerHTML = '<div class="empty-state">No Number of Agglomerations columns found in data</div>';
                        return;
                    }
                    displayColumns = ['ISO', 'Country', ...numAgglosCols];
                    tableTitle = 'Africapolis Country Data - Number of Agglomerations';
                    break;
                case 'mpop':
                    if (mpopCols.length === 0) {
                        panel.innerHTML = '<div class="empty-state">No Metropolitan Population columns found in data</div>';
                        return;
                    }
                    displayColumns = [getOriginalColName('ISO'), getOriginalColName('Country'), ...mpopCols];
                    tableTitle = 'Africapolis Country Data - Metropolitan Population';
                    break;
                case 'adba':
                    if (adbaCols.length === 0) {
                        panel.innerHTML = '<div class="empty-state">No Distance between Agglomerations columns found in data</div>';
                        return;
                    }
                    displayColumns = [getOriginalColName('ISO'), getOriginalColName('Country'), ...adbaCols];
                    tableTitle = 'Africapolis Country Data - Distance between Agglomerations';
                    break;
                case 'environment':
                    if (envCols.length === 0) {
                        panel.innerHTML = '<div class="empty-state">No Environment columns found in data</div>';
                        return;
                    }
                    displayColumns = [getOriginalColName('ISO'), getOriginalColName('Country'), ...envCols];
                    tableTitle = 'Africapolis Country Data - Environment';
                    break;
                default:
                    displayColumns = basicCols.filter(col => allColumns.includes(col));
                    tableTitle = 'Africapolis Country Data - Basic Information';
            }
            
            // Ensure we have at least ISO and Country columns
            if (displayColumns.length === 0) {
                panel.innerHTML = '<div class="empty-state">No data columns available</div>';
                return;
            }
            
            panel.innerHTML = `
                <div class="table-header-fixed">
                    <div class="chart-title">${tableTitle}</div>
                    <div class="country-type-selector" id="africapolisTypeSelector">
                        <label>Show:</label>
                        <label class="country-type-checkbox">
                            <input type="checkbox" data-type="country" checked> Countries
                        </label>
                        <label class="country-type-checkbox">
                            <input type="checkbox" data-type="region" checked> Regions
                        </label>
                        <label class="country-type-checkbox">
                            <input type="checkbox" data-type="continent" checked> Continent
                        </label>
                        <label class="country-type-checkbox">
                            <input type="checkbox" data-type="organization" checked> Regional Entities
                        </label>
                    </div>
                </div>
                <div class="table-container">
                    ${renderAfricapolisTable(displayColumns, 'africapolisTable')}
                </div>
            `;
            
            // Bind type selector checkboxes
            const africapolisTypeSelectorEl = document.getElementById('africapolisTypeSelector');
            if (africapolisTypeSelectorEl) {
                africapolisTypeSelectorEl.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                        filterTableByType('africapolisTable');
                    }
                });
            }
        }

        function renderAfricapolisTable(columns, tableId) {
            const getCountryTypeClass = (country) => {
                const type = getCountryType(country);
                return `table-row-${type}`;
            };
            
            const getCountryTypeBadge = (country) => {
                const type = getCountryType(country);
                const typeLabels = {
                    'country': 'Country',
                    'region': 'Region',
                    'continent': 'Continent',
                    'organization': 'Regional Entities'
                };
                return `<span class="country-type-badge country-type-${type}">${typeLabels[type]}</span>`;
            };
            
            let html = `<table class="data-table" id="${tableId}"><thead><tr>`;
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Use filteredData if available, otherwise use all data
            const dataToRender = filteredData.length > 0 ? filteredData : (allData['Africapolis_Country'] || []);
            
            dataToRender.forEach((row, index) => {
                // Get Country value (handle spaces in column name)
                const countryCol = columns.find(c => c.trim() === 'Country' || c === 'Country') || 'Country';
                const countryValue = row[countryCol] || row['Country'] || row[' Country '] || '';
                const countryTypeClass = getCountryTypeClass(countryValue);
                html += `<tr class="${countryTypeClass}" data-country-type="${getCountryType(countryValue)}" data-row-index="${index}">`;
                columns.forEach(col => {
                    // Try to get value using the column name as-is, or try trimmed version
                    let value = row[col];
                    if (value === undefined || value === null || value === '') {
                        // Try trimmed column name
                        const trimmedCol = col.trim();
                        if (trimmedCol !== col && row[trimmedCol] !== undefined) {
                            value = row[trimmedCol];
                        }
                    }
                    let displayValue = '';
                    // Check if column is Country (handle spaces)
                    const isCountryCol = col.trim() === 'Country' || col === 'Country';
                    if (isCountryCol) {
                        // Add type badge to Country column
                        displayValue = value || '';
                        if (displayValue) {
                            displayValue += getCountryTypeBadge(value);
                        }
                    } else if (typeof value === 'number') {
                        // Format numeric values
                        const colTrimmed = col.trim();
                        if (colTrimmed.startsWith('Mpop')) {
                            // Mpop is percentage (as decimal) - format as percentage with 2 decimal places
                            displayValue = (value * 100).toFixed(2) + '%';
                        } else if (colTrimmed.startsWith('Upop') || colTrimmed.startsWith('TPOP') || 
                                   colTrimmed.startsWith('ADBA') || colTrimmed.startsWith('NumAgglos')) {
                            // Population and count columns - format as integers with commas
                            displayValue = Math.round(value).toLocaleString('en-US');
                        } else if (colTrimmed.startsWith('Usurf') || colTrimmed.startsWith('Area') || 
                                   colTrimmed.includes('TotalFootprint') || colTrimmed.includes('street_length')) {
                            // Area and length columns - format with 2 decimal places
                            displayValue = value.toFixed(2).toLocaleString('en-US');
                        } else if (colTrimmed.startsWith('Urbanlevel')) {
                            // Urbanlevel is percentage (as decimal) - format as percentage with 2 decimal places
                            displayValue = (value * 100).toFixed(2) + '%';
                        } else if (colTrimmed.includes('_p_') || 
                                   col.includes('Sprawl') || col.includes('Elongation') || 
                                   col.includes('int_density') || col.includes('PM2.5')) {
                            // Percentage and ratio columns - format with 2 decimal places
                            displayValue = value.toFixed(2);
                        } else {
                            displayValue = value % 1 === 0 ? value.toLocaleString('en-US') : value.toFixed(2);
                        }
                    } else {
                        displayValue = value || '';
                    }
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        // Store play interval globally to allow cleanup
        let globalMapPlayInterval = null;
        let isAutoPlaying = false; // Flag to prevent event loops during auto-play
        let yearSliderHandler = null;
        let yearValueHandler = null;
        let playButtonHandler = null;

        // Function to clear map highlights
        function clearMapHighlights() {
            if (mapG) {
                mapG.selectAll('.country-path').classed('highlighted', false);
                mapG.selectAll('.population-circle').classed('highlighted', false);
                mapG.selectAll('.pie-arc')
                    .attr('stroke', '#FFFFFF')
                    .attr('stroke-width', 1)
                    .attr('filter', null);
            }
        }

        function initializeMap() {
            // Stop any existing auto-play
            if (globalMapPlayInterval) {
                clearInterval(globalMapPlayInterval);
                globalMapPlayInterval = null;
            }
            
            // Use allData for map, filter countries only
            const data = allData[currentSheet] || [];
            const countryData = data.filter(row => getCountryType(row.Country) === 'country');
            
            if (countryData.length === 0) {
                document.getElementById('mapContainer').innerHTML = '<div class="empty-state">No country data found.</div>';
                return;
            }

            // Load GeoJSON and render map
            loadGeoJSON().then(() => {
                renderMapVisualization(countryData);
                
                // Handle window resize for responsive map
                let resizeTimer;
                window.addEventListener('resize', function() {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(function() {
                        if (mapSvg && mapG) {
                            const container = document.getElementById('mapContainer');
                            const width = container.clientWidth;
                            const height = container.clientHeight;
                            
                            // Update SVG dimensions
                            mapSvg.attr('width', width).attr('height', height);
                            
                            // Update projection with margin
                            mapProjection
                                .scale(Math.min(width, height) * 0.6)
                                .translate([width / 2, height / 2]);
                            
                            // Update paths and circles
                            mapG.selectAll('.country-path').attr('d', mapPath);
                            // Update circles
                            mapG.selectAll('.population-circle').each(function(d) {
                                const center = d3.geoCentroid(d);
                                const coords = mapProjection(center);
                                d3.select(this)
                                    .attr('cx', coords[0])
                                    .attr('cy', coords[1]);
                            });
                            // Update pie charts
                            mapG.selectAll('.population-pie').attr('transform', function(d) {
                                const center = d3.geoCentroid(d);
                                const coords = mapProjection(center);
                                return `translate(${coords[0]}, ${coords[1]})`;
                            });
                        }
                    }, 250);
                });
            });

            // Bind controls
            const yearSlider = document.getElementById('mapYear');
            const yearValue = document.getElementById('mapYearValue');
            const playButton = document.getElementById('mapPlayButton');
            let isPlaying = false;
            
            // Stop any existing auto-play
            if (globalMapPlayInterval) {
                clearInterval(globalMapPlayInterval);
                globalMapPlayInterval = null;
                isPlaying = false;
                playButton.classList.remove('playing');
                playButton.classList.add('paused');
            }
            isAutoPlaying = false;
            
            // Remove old event listeners if they exist
            if (yearSliderHandler) {
                yearSlider.removeEventListener('input', yearSliderHandler);
            }
            if (yearValueHandler) {
                yearValue.removeEventListener('change', yearValueHandler);
            }
            if (playButtonHandler) {
                playButton.removeEventListener('click', playButtonHandler);
            }
            
            // Sync slider and select dropdown
            yearSliderHandler = function() {
                // Skip if auto-playing to prevent event loops
                if (isAutoPlaying) return;
                const year = this.value;
                yearValue.value = year;
                renderMapVisualization(countryData);
                highlightYearColumns(year);
            };
            yearSlider.addEventListener('input', yearSliderHandler);
            
            // Update slider and map when select changes
            yearValueHandler = function() {
                // Skip if auto-playing to prevent event loops
                if (isAutoPlaying) return;
                const year = this.value;
                yearSlider.value = year;
                renderMapVisualization(countryData);
                highlightYearColumns(year);
            };
            yearValue.addEventListener('change', yearValueHandler);
            
            // Auto-play functionality
            playButtonHandler = function() {
                if (isPlaying) {
                    // Pause
                    if (globalMapPlayInterval) {
                        clearInterval(globalMapPlayInterval);
                        globalMapPlayInterval = null;
                    }
                    isAutoPlaying = false;
                    isPlaying = false;
                    playButton.classList.remove('playing');
                    playButton.classList.add('paused');
                } else {
                    // Play
                    isPlaying = true;
                    playButton.classList.remove('paused');
                    playButton.classList.add('playing');
                    
                    globalMapPlayInterval = setInterval(function() {
                        const currentYear = parseInt(yearSlider.value);
                        const minYear = parseInt(yearSlider.min);
                        const maxYear = parseInt(yearSlider.max);
                        const step = parseInt(yearSlider.step);
                        
                        let nextYear = currentYear + step;
                        if (nextYear > maxYear) {
                            // Stop at maxYear instead of looping
                            if (globalMapPlayInterval) {
                                clearInterval(globalMapPlayInterval);
                                globalMapPlayInterval = null;
                            }
                            isAutoPlaying = false;
                            isPlaying = false;
                            playButton.classList.remove('playing');
                            playButton.classList.add('paused');
                            return;
                        }
                        
                        // Set flag to prevent input/change events from triggering
                        isAutoPlaying = true;
                        yearSlider.value = nextYear;
                        yearValue.value = nextYear;
                        renderMapVisualization(countryData);
                        // Update year column highlighting during playback
                        highlightYearColumns(nextYear);
                        // Reset flag after a short delay to allow manual changes
                        setTimeout(function() {
                            isAutoPlaying = false;
                        }, 50);
                    }, 1000); // Update every 1 second
                }
            };
            playButton.addEventListener('click', playButtonHandler);
            
            // mapSizeClass is now merged with sizeClassFilter, no separate handler needed
        }

        function loadGeoJSON() {
            if (geoData) {
                return Promise.resolve(geoData);
            }
            return fetch('./africa.geojson')
                .then(response => response.json())
                .then(data => {
                    geoData = data;
                    return data;
                })
                .catch(err => {
                    console.error('Error loading GeoJSON:', err);
                    document.getElementById('contentPanel').innerHTML = 
                        '<div class="empty-state">Unable to load map data. Please ensure africa.geojson exists.</div>';
                });
        }

        function renderMapVisualization(countryData) {
            if (!geoData) return;

            const year = document.getElementById('mapYear')?.value || '2020';
            const sizeClassFilterEl = document.getElementById('sizeClassFilter');
            const sizeClassValue = sizeClassFilterEl ? sizeClassFilterEl.value : '';
            const sizeClass = sizeClassValue || 'Total';
            const countryFilter = selectedCountry;

            // Check if we're in "All Size Classes" mode (empty value means "All Size Classes")
            const isAllSizeClasses = sizeClassValue === '';

            // Calculate GLOBAL min/max for all years and all size classes
            // This ensures consistent mapping scale regardless of current filter
            const globalDataByCountry = {};
            const allYears = ['2020', '2025', '2030', '2035', '2040', '2045', '2050'];
            
            countryData.forEach(row => {
                const isoCode = row.Country;
                if (!globalDataByCountry[isoCode]) {
                    globalDataByCountry[isoCode] = {
                        isoCode: isoCode,
                        area: 0,
                        population: 0
                    };
                }
                // Aggregate all years for global range
                allYears.forEach(y => {
                    globalDataByCountry[isoCode].area = Math.max(
                        globalDataByCountry[isoCode].area,
                        row[`Area_${y}`] || 0
                    );
                    globalDataByCountry[isoCode].population = Math.max(
                        globalDataByCountry[isoCode].population,
                        row[`Population_${y}`] || 0
                    );
                });
            });

            // Calculate global min/max for scales
            const globalAreaValues = Object.values(globalDataByCountry).map(d => d.area).filter(v => v > 0);
            const globalPopulationValues = Object.values(globalDataByCountry).map(d => d.population).filter(v => v > 0);
            const globalAreaMin = d3.min(globalAreaValues) || 0;
            const globalAreaMax = d3.max(globalAreaValues) || 1;
            const globalPopMin = d3.min(globalPopulationValues) || 0;
            const globalPopMax = d3.max(globalPopulationValues) || 1;

            // Prepare data: aggregate by country (for current filter)
            const dataByCountry = {};
            const dataByCountryAndSize = {}; // For pie chart when All Size Classes
            
            countryData.forEach(row => {
                const normalizedSizeClass = normalizeSizeClass(row.Size_Class);
                const filterNormalized = normalizeSizeClass(sizeClass);
                    const isoCode = row.Country;
                
                // Initialize country data structure
                    if (!dataByCountry[isoCode]) {
                        dataByCountry[isoCode] = {
                            isoCode: isoCode,
                            area: 0,
                            population: 0
                        };
                    }
                
                if (!dataByCountryAndSize[isoCode]) {
                    dataByCountryAndSize[isoCode] = {
                        isoCode: isoCode,
                        S: { area: 0, population: 0 },
                        M: { area: 0, population: 0 },
                        L: { area: 0, population: 0 },
                        Total: { area: 0, population: 0 }
                    };
                }
                
                // For 'All Size Classes' mode, collect S, M, L separately (exclude Total rows)
                if (isAllSizeClasses) {
                    if (normalizedSizeClass === 'S' || normalizedSizeClass === 'M' || normalizedSizeClass === 'L') {
                        dataByCountryAndSize[isoCode][normalizedSizeClass].area += row[`Area_${year}`] || 0;
                        dataByCountryAndSize[isoCode][normalizedSizeClass].population += row[`Population_${year}`] || 0;
                        // Also add to Total for size mapping
                    dataByCountry[isoCode].area += row[`Area_${year}`] || 0;
                    dataByCountry[isoCode].population += row[`Population_${year}`] || 0;
                    }
                } else {
                    // For specific size class, use normal filtering
                    let shouldInclude = false;
                    if (sizeClass === 'Total') {
                        shouldInclude = (row.Size_Class === 'Total' || normalizedSizeClass === 'Total');
                    } else {
                        shouldInclude = (normalizedSizeClass === filterNormalized);
                    }
                    
                    if (shouldInclude) {
                        dataByCountry[isoCode].area += row[`Area_${year}`] || 0;
                        dataByCountry[isoCode].population += row[`Population_${year}`] || 0;
                    }
                }
            });

            // Clear previous map
            d3.select('#mapContainer').selectAll('*').remove();

            // Create SVG that fills the container
            const container = document.getElementById('mapContainer');
            // Wait a bit to ensure container has rendered size, then get dimensions
            setTimeout(() => {
                const width = container.offsetWidth || container.clientWidth || 500;
                const height = container.offsetHeight || container.clientHeight || 400;
                
                if (mapSvg) {
                    mapSvg.attr('width', width).attr('height', height);
                    // Update projection with margin
                    mapProjection
                        .scale(Math.min(width, height) * 0.6)
                        .translate([width / 2, height / 2]);
                    // Redraw paths
                    mapG.selectAll('.country-path').attr('d', mapPath);
                    mapG.selectAll('.population-circle').each(function(d) {
                        const center = d3.geoCentroid(d);
                        const coords = mapProjection(center);
                        d3.select(this)
                            .attr('cx', coords[0])
                            .attr('cy', coords[1]);
                    });
                }
            }, 100);
            
            // Use initial dimensions for first render
            const width = container.offsetWidth || container.clientWidth || 500;
            const height = container.offsetHeight || container.clientHeight || 400;

            mapSvg = d3.select('#mapContainer')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create a group for all map elements (for zoom/pan)
            mapG = mapSvg.append('g').attr('class', 'map-group');

            // Create or get tooltip element
            let tooltip = d3.select('#mapContainer .map-tooltip');
            if (tooltip.empty()) {
                tooltip = d3.select('#mapContainer')
                    .append('div')
                    .attr('class', 'map-tooltip')
                    .style('position', 'absolute');
            } else {
                tooltip.classed('visible', false);
            }

            // Create projection (Mercator for Africa) - scale with margin
            mapProjection = d3.geoMercator()
                .center([20, 0])
                .scale(Math.min(width, height) * 0.6)  // Use smaller dimension and add margin
                .translate([width / 2, height / 2]);

            mapPath = d3.geoPath().projection(mapProjection);

            // Set up zoom behavior
            mapZoom = d3.zoom()
                .scaleExtent([0.5, 8])  // Allow zoom from 0.5x to 8x
                .on('zoom', function(event) {
                    // Apply transform to the group containing all map elements
                    mapG.attr('transform', event.transform);
                });

            // Initialize zoom transform to center the map
            const initialTransform = d3.zoomIdentity
                .translate(width / 2, height / 2)
                .scale(1)
                .translate(-width / 2, -height / 2);
            
            mapSvg.call(mapZoom.transform, initialTransform);
            mapSvg.call(mapZoom);

            // Use GLOBAL min/max for scales (consistent mapping regardless of filter)
            const areaMin = globalAreaMin;
            const areaMax = globalAreaMax;
            const popMin = globalPopMin;
            const popMax = globalPopMax;

            // Color scales using global Nordic color scheme
            // Area: Use warm colors from Nordic palette (#D4A574 brown/orange tones)
            const areaColorScale = d3.scaleSequential(t => {
                // Interpolate from light (#F5E8D4) to dark brown (#D4A574)
                return d3.interpolateRgb('#F5E8D4', '#D4A574')(t);
            }).domain([areaMin, areaMax]);

            // Population: Use cool colors from Nordic palette (#5B8FA3 blue tones)
            const popColorScale = d3.scaleSequential(t => {
                // Interpolate from light (#E8F0F5) to dark blue (#5B8FA3)
                return d3.interpolateRgb('#E8F0F5', '#5B8FA3')(t);
            }).domain([popMin, popMax]);

            // Size scale for circles (using GLOBAL range)
            const popSizeScale = d3.scaleSqrt()
                .domain([popMin, popMax])
                .range([3, 20]);

            // Draw countries (inside the g element for zoom/pan)
            const countries = mapG.selectAll('.country-path')
                .data(geoData.features)
                .enter()
                .append('path')
                .attr('class', 'country-path')
                .attr('d', mapPath)
                .attr('data-country-name', d => d.properties.name)
                .attr('fill', d => {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    if (isoCode && dataByCountry[isoCode]) {
                        return areaColorScale(dataByCountry[isoCode].area);
                    }
                    return '#E8E6E1'; // Default color for countries without data
                })
                .on('click', function(event, d) {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    if (isoCode) {
                        // If clicking the same country, deselect it
                        if (selectedCountry === isoCode) {
                            selectedCountry = '';
                            clearMapHighlights();
                            const countrySearchInput = document.getElementById('countrySearchInput');
                            if (countrySearchInput) {
                                countrySearchInput.value = '';
                                document.getElementById('countrySearchClear').style.display = 'none';
                            }
                            applyFilters();
                        } else {
                            // Clear all highlights
                            clearMapHighlights();
                            
                            // Highlight clicked country
                            d3.select(this).classed('highlighted', true);
                            
                            // Set country filter and apply filters
                            selectedCountry = isoCode;
                            const countrySearchInput = document.getElementById('countrySearchInput');
                            if (countrySearchInput) {
                                countrySearchInput.value = isoCode;
                                document.getElementById('countrySearchClear').style.display = 'block';
                            }
                            applyFilters();
                        }
                    }
                })
                .on('mouseover', function(event, d) {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    if (isoCode && dataByCountry[isoCode]) {
                        const data = dataByCountry[isoCode];
                        d3.select(this).style('opacity', 0.7);
                        
                        // Show tooltip
                        const [x, y] = d3.pointer(event);
                        tooltip
                            .html(`
                                <div class="map-tooltip-title">${countryName}</div>
                                <div class="map-tooltip-item">
                                    <span class="map-tooltip-label">Area:</span>
                                    <span class="map-tooltip-value">${Math.round(data.area).toLocaleString('en-US')} km²</span>
                                </div>
                                <div class="map-tooltip-item">
                                    <span class="map-tooltip-label">Population:</span>
                                    <span class="map-tooltip-value">${Math.round(data.population).toLocaleString('en-US')}</span>
                                </div>
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #E8E6E1; font-size: 10px; color: #6B7A8A;">
                                    Click to filter data
                                </div>
                            `)
                            .style('left', (x + 10) + 'px')
                            .style('top', (y - 10) + 'px')
                            .classed('visible', true);
                    }
                })
                .on('mousemove', function(event) {
                    const countryName = d3.select(this).attr('data-country-name');
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    if (isoCode && dataByCountry[isoCode]) {
                        const [x, y] = d3.pointer(event);
                        tooltip
                            .style('left', (x + 10) + 'px')
                            .style('top', (y - 10) + 'px');
                    }
                })
                .on('mouseout', function() {
                    d3.select(this).style('opacity', 1);
                    tooltip.classed('visible', false);
                });

            // Apply highlight if country is selected in filter
            if (countryFilter) {
                countries.filter(d => {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    return isoCode === countryFilter;
                })
                .classed('highlighted', true);
            }

            // Also apply highlight to selected country after rendering (for persistence)
            if (selectedCountry) {
                mapG.selectAll('.country-path').filter(function(d) {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    return isoCode === selectedCountry;
                }).classed('highlighted', true);
                
                mapG.selectAll('.population-circle').filter(function(d) {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    return isoCode === selectedCountry;
                }).classed('highlighted', true);
                
                mapG.selectAll('.population-pie').filter(function(d) {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    return isoCode === selectedCountry;
                }).selectAll('.pie-arc')
                .attr('stroke', '#5B8FA3')
                .attr('stroke-width', 2.5);
            }

            // Draw population visualization (circles or pie charts)
            const populationFeatures = geoData.features.filter(d => {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    return isoCode && dataByCountry[isoCode] && dataByCountry[isoCode].population > 0;
            });
            
            if (isAllSizeClasses) {
                // Draw pie charts for All Size Classes mode
                const pie = d3.pie()
                    .value(d => d.value)
                    .sort(null);
                
                const pieGroups = mapG.selectAll('.population-pie')
                    .data(populationFeatures)
                    .enter()
                    .append('g')
                    .attr('class', 'population-pie')
                    .attr('transform', d => {
                        const center = d3.geoCentroid(d);
                        const coords = mapProjection(center);
                        return `translate(${coords[0]}, ${coords[1]})`;
                    });
                
                pieGroups.each(function(d) {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    const countryData = dataByCountryAndSize[isoCode];
                    
                    if (!countryData) return;
                    
                    // Calculate total for size mapping
                    const totalPop = countryData.S.population + countryData.M.population + countryData.L.population;
                    if (totalPop === 0) return;
                    
                    const radius = popSizeScale(totalPop);
                    
                    // Prepare pie data with population values for color mapping
                    const pieData = [
                        { label: 'S', value: countryData.S.population, population: countryData.S.population },
                        { label: 'M', value: countryData.M.population, population: countryData.M.population },
                        { label: 'L', value: countryData.L.population, population: countryData.L.population }
                    ].filter(item => item.value > 0);
                    
                    if (pieData.length === 0) return;
                    
                    const arcs = pie(pieData);
                    
                    const arc = d3.arc()
                        .innerRadius(0)
                        .outerRadius(radius);
                    
                    const g = d3.select(this);
                    g.selectAll('.pie-arc')
                        .data(arcs)
                        .enter()
                        .append('path')
                        .attr('class', 'pie-arc')
                        .attr('d', arc)
                        .attr('fill', d => {
                            // Use global color scale based on this segment's population value
                            return popColorScale(d.data.population);
                        })
                        .attr('stroke', '#FFFFFF')
                        .attr('stroke-width', 1)
                        .attr('opacity', 0.85)
                        .attr('data-country-name', countryName)
                        .attr('data-country-code', isoCode);
                });
                
                // Add event handlers to pie groups
                pieGroups
                    .on('click', function(event, d) {
                        const countryName = d.properties.name;
                        const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                        if (isoCode) {
                            // If clicking the same country, deselect it
                            if (selectedCountry === isoCode) {
                                selectedCountry = '';
                                clearMapHighlights();
                                const countrySearchInput = document.getElementById('countrySearchInput');
                                if (countrySearchInput) {
                                    countrySearchInput.value = '';
                                    document.getElementById('countrySearchClear').style.display = 'none';
                                }
                                applyFilters();
                            } else {
                                // Clear all highlights
                                clearMapHighlights();
                                
                                // Highlight clicked country path
                                mapG.selectAll('.country-path').filter(function(pathD) {
                                    return COUNTRY_NAME_TO_ISO[pathD.properties.name] === isoCode;
                                }).classed('highlighted', true);
                                
                                // Highlight clicked pie chart
                                d3.select(this).selectAll('.pie-arc')
                                .attr('stroke', '#5B8FA3')
                                .attr('stroke-width', 2.5);
                            
                            selectedCountry = isoCode;
                                const countrySearchInput = document.getElementById('countrySearchInput');
                                if (countrySearchInput) {
                                    countrySearchInput.value = isoCode;
                                    document.getElementById('countrySearchClear').style.display = 'block';
                                }
                                applyFilters();
                            }
                        }
                    })
                    .on('mouseover', function(event, d) {
                        const countryName = d.properties.name;
                        const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                        const countryData = dataByCountryAndSize[isoCode];
                        if (countryData) {
                            d3.select(this).selectAll('.pie-arc').attr('opacity', 1);
                            
                            const totalPop = countryData.S.population + countryData.M.population + countryData.L.population;
                            const [x, y] = d3.pointer(event);
                            tooltip
                                .html(`
                                    <div class="map-tooltip-title">${countryName}</div>
                                    <div class="map-tooltip-item">
                                        <span class="map-tooltip-label">Total Population:</span>
                                        <span class="map-tooltip-value">${Math.round(totalPop).toLocaleString('en-US')}</span>
                                    </div>
                                    <div class="map-tooltip-item">
                                        <span class="map-tooltip-label">S:</span>
                                        <span class="map-tooltip-value">${Math.round(countryData.S.population).toLocaleString('en-US')}</span>
                                    </div>
                                    <div class="map-tooltip-item">
                                        <span class="map-tooltip-label">M:</span>
                                        <span class="map-tooltip-value">${Math.round(countryData.M.population).toLocaleString('en-US')}</span>
                                    </div>
                                    <div class="map-tooltip-item">
                                        <span class="map-tooltip-label">L:</span>
                                        <span class="map-tooltip-value">${Math.round(countryData.L.population).toLocaleString('en-US')}</span>
                                    </div>
                                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #E8E6E1; font-size: 10px; color: #6B7A8A;">
                                        Click to filter data
                                    </div>
                                `)
                                .style('left', (x + 10) + 'px')
                                .style('top', (y - 10) + 'px')
                                .classed('visible', true);
                        }
                    })
                    .on('mousemove', function(event) {
                        const [x, y] = d3.pointer(event);
                        tooltip
                            .style('left', (x + 10) + 'px')
                            .style('top', (y - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select(this).selectAll('.pie-arc').attr('opacity', 0.85);
                        tooltip.classed('visible', false);
                    });
                
                // Apply highlight to pie groups
                if (countryFilter) {
                    pieGroups.filter(d => {
                        const countryName = d.properties.name;
                        const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                        return isoCode === countryFilter;
                    })
                    .selectAll('.pie-arc')
                    .attr('stroke', '#5B8FA3')
                    .attr('stroke-width', 2.5);
                }
            } else {
                // Draw circles for specific size class mode
                const circles = mapG.selectAll('.population-circle')
                    .data(populationFeatures)
                .enter()
                .append('circle')
                .attr('class', 'population-circle')
                .attr('cx', d => {
                    const center = d3.geoCentroid(d);
                    return mapProjection(center)[0];
                })
                .attr('cy', d => {
                    const center = d3.geoCentroid(d);
                    return mapProjection(center)[1];
                })
                .attr('r', d => {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    return popSizeScale(dataByCountry[isoCode].population);
                })
                .attr('fill', d => {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    return popColorScale(dataByCountry[isoCode].population);
                })
                    .attr('data-country-name', d => d.properties.name)
                .attr('data-country-code', d => {
                    const countryName = d.properties.name;
                    return COUNTRY_NAME_TO_ISO[countryName];
                    })
                    .on('click', function(event, d) {
                        const countryName = d.properties.name;
                        const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                        if (isoCode) {
                            // If clicking the same country, deselect it
                            if (selectedCountry === isoCode) {
                                selectedCountry = '';
                                clearMapHighlights();
                                const countrySearchInput = document.getElementById('countrySearchInput');
                                if (countrySearchInput) {
                                    countrySearchInput.value = '';
                                    document.getElementById('countrySearchClear').style.display = 'none';
                                }
                                applyFilters();
                            } else {
                                // Clear all highlights
                                clearMapHighlights();
                                
                                // Highlight clicked country path
                                mapG.selectAll('.country-path').filter(function(pathD) {
                                    return COUNTRY_NAME_TO_ISO[pathD.properties.name] === isoCode;
                                }).classed('highlighted', true);
                                
                                // Highlight clicked circle
                                d3.select(this).classed('highlighted', true);
                                
                                selectedCountry = isoCode;
                                const countrySearchInput = document.getElementById('countrySearchInput');
                                if (countrySearchInput) {
                                    countrySearchInput.value = isoCode;
                                    document.getElementById('countrySearchClear').style.display = 'block';
                                }
                                applyFilters();
                            }
                        }
                    })
                    .on('mouseover', function(event, d) {
                        const countryName = d.properties.name;
                        const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                        if (isoCode && dataByCountry[isoCode]) {
                            const data = dataByCountry[isoCode];
                            d3.select(this).style('opacity', 0.8);
                            
                            const [x, y] = d3.pointer(event);
                            tooltip
                                .html(`
                                    <div class="map-tooltip-title">${countryName}</div>
                                    <div class="map-tooltip-item">
                                        <span class="map-tooltip-label">Area:</span>
                                        <span class="map-tooltip-value">${Math.round(data.area).toLocaleString('en-US')} km²</span>
                                    </div>
                                    <div class="map-tooltip-item">
                                        <span class="map-tooltip-label">Population:</span>
                                        <span class="map-tooltip-value">${Math.round(data.population).toLocaleString('en-US')}</span>
                                    </div>
                                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #E8E6E1; font-size: 10px; color: #6B7A8A;">
                                        Click to filter data
                                    </div>
                                `)
                                .style('left', (x + 10) + 'px')
                                .style('top', (y - 10) + 'px')
                                .classed('visible', true);
                        }
                    })
                    .on('mousemove', function(event) {
                        const countryName = d3.select(this).attr('data-country-name');
                        const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                        if (isoCode && dataByCountry[isoCode]) {
                            const [x, y] = d3.pointer(event);
                            tooltip
                                .style('left', (x + 10) + 'px')
                                .style('top', (y - 10) + 'px');
                        }
                    })
                    .on('mouseout', function() {
                        d3.select(this).style('opacity', 0.6);
                        tooltip.classed('visible', false);
                });

            // Apply highlight to circles
            if (countryFilter) {
                circles.filter(d => {
                    const countryName = d.properties.name;
                    const isoCode = COUNTRY_NAME_TO_ISO[countryName];
                    return isoCode === countryFilter;
                })
                .classed('highlighted', true);
                }
            }

            // Update legend
            updateMapLegend(areaMin, areaMax, popMin, popMax);
        }

        function updateMapLegend(areaMin, areaMax, popMin, popMax) {
            // Calculate size scale for legend (same as in renderMapVisualization)
            const popSizeScale = d3.scaleSqrt()
                .domain([popMin, popMax])
                .range([3, 20]);
            
            // Create continuous size examples
            const minSize = popSizeScale(popMin);
            const maxSize = popSizeScale(popMax);
            const midSize = popSizeScale((popMin + popMax) / 2);
            
            const legendContent = d3.select('#mapLegendContent');
            legendContent.html(`
                <div class="map-legend-item">
                    <span>Area (km²)</span>
                </div>
                <div class="map-legend-item">
                    <div class="map-legend-color" style="background: linear-gradient(to right, #F5E8D4, #D4A574); width: 60px; height: 12px;"></div>
                    <span>${Math.round(areaMin).toLocaleString()} - ${Math.round(areaMax).toLocaleString()}</span>
                </div>
                <div class="map-legend-item" style="margin-top: 8px;">
                    <span>Population</span>
                </div>
                <div class="map-legend-item" style="display: flex; align-items: center; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="background: #5B8FA3; border-radius: 50%; width: ${minSize}px; height: ${minSize}px; flex-shrink: 0;"></div>
                        <span style="font-size: 10px;">${Math.round(popMin).toLocaleString()}</span>
                </div>
                    <span style="color: #999;">→</span>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="background: #5B8FA3; border-radius: 50%; width: ${maxSize}px; height: ${maxSize}px; flex-shrink: 0;"></div>
                        <span style="font-size: 10px;">${Math.round(popMax).toLocaleString()}</span>
                </div>
                </div>
            `);
        }

        function renderFormulas() {
            const panel = document.getElementById('referenceContent');
            const formulasData = allData['Formulas'] || [];
            
            if (formulasData.length === 0) {
                panel.innerHTML = '<div class="empty-state">No formulas data found</div>';
                return;
            }
            
            // Get column names from first row (header)
            const columns = Object.keys(formulasData[0]);
            
            let html = `
                <div class="table-header-fixed">
                <div class="chart-title">Formulas & Field Definitions</div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="formulasTable">
                        <thead><tr>
            `;
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            formulasData.forEach((row, index) => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col] || '';
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            panel.innerHTML = html;
        }

        function renderREADME() {
            const panel = document.getElementById('referenceContent');
            const readmeData = allData['README'] || [];
            
            if (readmeData.length === 0) {
                panel.innerHTML = '<div class="empty-state">No README data found</div>';
                return;
            }
            
            // Get column names from first row (header)
            const columns = Object.keys(readmeData[0]);
            
            let html = `
                <div class="table-header-fixed">
                <div class="chart-title">README Documentation</div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="readmeTable">
                        <thead><tr>
            `;
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            readmeData.forEach((row, index) => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col] || '';
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            panel.innerHTML = html;
        }

        function renderTable(columns, tableId) {
            // Get current selected year from map
            const currentYear = document.getElementById('mapYearValue')?.value || document.getElementById('mapYear')?.value || '2020';
            
            const getSizeClassClass = (sizeClass) => {
                if (!sizeClass) return '';
                const normalized = normalizeSizeClass(sizeClass);
                if (normalized === 'S') return 'size-class-s';
                if (normalized === 'M') return 'size-class-m';
                if (normalized === 'L') return 'size-class-l';
                if (normalized === 'Total') return 'size-class-total';
                return '';
            };
            
            const getCountryTypeClass = (country) => {
                const type = getCountryType(country);
                return `table-row-${type}`;
            };
            
            const getCountryTypeBadge = (country) => {
                const type = getCountryType(country);
                const typeLabels = {
                    'country': 'Country',
                    'region': 'Region',
                    'continent': 'Continent',
                    'organization': 'Regional Entities'
                };
                return `<span class="country-type-badge country-type-${type}">${typeLabels[type]}</span>`;
            };
            
            // Identify metric columns (columns that can have difference calculated)
            const metricColumns = columns.filter(col => 
                (col.startsWith('Population_') || col.startsWith('Area_') || 
                 col.startsWith('Count_') || col.startsWith('Growth_')) &&
                !col.includes('Added') && !col.includes('Growth')
            );
            
            // Calculate difference columns if enabled
            const differenceColumns = [];
            if (showDifference && currentDataSource === 'urban-metrics') {
                // Get unique base names (e.g., Population, Area, Count)
                const baseNames = [...new Set(metricColumns.map(col => {
                    const parts = col.split('_');
                    return parts.slice(0, -1).join('_'); // Everything except the last part (year)
                }))];
                
                baseNames.forEach(baseName => {
                    const startCol = `${baseName}_${differenceStartYear}`;
                    const endCol = `${baseName}_${differenceEndYear}`;
                    
                    // Check if both start and end columns exist in the columns array
                    if (columns.includes(startCol) && columns.includes(endCol)) {
                        // Create a readable display name
                        const metricName = baseName.replace(/_/g, ' ');
                        differenceColumns.push({
                            baseName: baseName,
                            startCol: startCol,
                            endCol: endCol,
                            displayName: `${metricName} Diff (${differenceEndYear}-${differenceStartYear})`
                        });
                    }
                });
            }
            
            let html = `<table class="data-table" id="${tableId}"><thead><tr>`;
            columns.forEach(col => {
                // Check if this column matches the current year
                const isYearColumn = (col.startsWith('Population_') || col.startsWith('Area_') || 
                                     col.startsWith('Count_') || col.startsWith('Growth_')) && 
                                    col.endsWith(`_${currentYear}`);
                const highlightClass = isYearColumn ? ' year-highlight' : '';
                html += `<th class="${highlightClass.trim()}" data-column="${col}">${col}</th>`;
            });
            
            // Add difference columns header
            differenceColumns.forEach(diffCol => {
                html += `<th class="difference-column" data-column="${diffCol.displayName}">${diffCol.displayName}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            filteredData.forEach((row, index) => {
                const sizeClass = getSizeClassClass(row.Size_Class);
                const countryTypeClass = getCountryTypeClass(row.Country);
                const rowClass = `${sizeClass} ${countryTypeClass}`.trim();
                html += `<tr class="${rowClass}" data-size-class="${row.Size_Class || ''}" data-country-type="${getCountryType(row.Country)}" data-row-index="${index}">`;
                columns.forEach(col => {
                    // Check if this column matches the current year
                    const isYearColumn = (col.startsWith('Population_') || col.startsWith('Area_') || 
                                         col.startsWith('Count_') || col.startsWith('Growth_')) && 
                                        col.endsWith(`_${currentYear}`);
                    const highlightClass = isYearColumn ? ' year-highlight' : '';
                    
                    let value = row[col];
                    let displayValue = '';
                    if (col === 'Country') {
                        // Add type badge to Country column
                        displayValue = value || '';
                        if (displayValue) {
                            displayValue += getCountryTypeBadge(value);
                        }
                    } else if (typeof value === 'number') {
                        // Format population and area columns as integers with comma separators
                        if (col.startsWith('Population_') || col.startsWith('Area_')) {
                            displayValue = Math.round(value).toLocaleString('en-US');
                        } else {
                            displayValue = value % 1 === 0 ? value : value.toFixed(2);
                        }
                    } else {
                        displayValue = value || '';
                    }
                    html += `<td class="${highlightClass.trim()}" data-column="${col}">${displayValue}</td>`;
                });
                
                // Add difference columns data
                differenceColumns.forEach(diffCol => {
                    // Get values from row, handling both number and string types
                    let startValue = row[diffCol.startCol];
                    let endValue = row[diffCol.endCol];
                    
                    // Convert to number if needed (handle string values)
                    if (typeof startValue !== 'number') {
                        startValue = parseNumberFromCell(startValue) || 0;
                    }
                    if (typeof endValue !== 'number') {
                        endValue = parseNumberFromCell(endValue) || 0;
                    }
                    
                    const difference = endValue - startValue;
                    
                    // Format difference using the same logic as original columns
                    let displayValue = '';
                    // Check if baseName starts with 'Population' or 'Area' (with or without underscore)
                    const isPopulationOrArea = diffCol.baseName.startsWith('Population') || diffCol.baseName.startsWith('Area');
                    
                    if (isPopulationOrArea) {
                        // Population and Area: round to integer and add comma separators
                        displayValue = Math.round(difference).toLocaleString('en-US');
                    } else {
                        // Other columns: integer if whole number, otherwise 2 decimal places
                        displayValue = difference % 1 === 0 ? difference.toString() : difference.toFixed(2);
                    }
                    
                    // Add sign for positive values (negative values already have minus sign)
                    if (difference > 0) {
                        displayValue = '+' + displayValue;
                    }
                    
                    html += `<td class="difference-column" data-column="${diffCol.displayName}">${displayValue}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        function highlightYearColumns(year) {
            // Only highlight if we're in urban-metrics mode
            if (currentDataSource !== 'urban-metrics') return;
            
            // Find all tables
            const tables = document.querySelectorAll('.data-table');
            tables.forEach(table => {
                // Remove previous highlights
                table.querySelectorAll('.year-highlight').forEach(el => {
                    el.classList.remove('year-highlight');
                });
                
                // Add highlight to matching columns
                const headers = table.querySelectorAll('thead th');
                
                headers.forEach((th, index) => {
                    const col = th.textContent || th.dataset.column || '';
                    const isYearColumn = (col.startsWith('Population_') || col.startsWith('Area_') || 
                                         col.startsWith('Count_') || col.startsWith('Growth_')) && 
                                        col.endsWith(`_${year}`);
                    if (isYearColumn) {
                        th.classList.add('year-highlight');
                        // Also highlight corresponding cells in tbody
                        const cells = table.querySelectorAll(`tbody td:nth-child(${index + 1})`);
                        cells.forEach(cell => {
                            cell.classList.add('year-highlight');
                        });
                    }
                });
            });
        }

        function normalizeSizeClass(sizeClass) {
            // Normalize size class to handle both formats:
            // "S (<100k)" and "S" -> both should match "S"
            // "M (100k-1M)" and "M" -> both should match "M"
            // "L (>1M)" and "L" -> both should match "L"
            if (!sizeClass) return '';
            if (sizeClass.startsWith('S')) return 'S';
            if (sizeClass.startsWith('M')) return 'M';
            if (sizeClass.startsWith('L')) return 'L';
            if (sizeClass === 'Total') return 'Total';
            return sizeClass;
        }
        
        function matchSizeClass(rowSizeClass, filterSizeClass) {
            // Match Size_Class considering both formats
            if (!filterSizeClass) return true;
            if (!rowSizeClass) return false;
            
            // Normalize both for comparison
            const normalizedRow = normalizeSizeClass(rowSizeClass);
            const normalizedFilter = normalizeSizeClass(filterSizeClass);
            
            return normalizedRow === normalizedFilter;
        }
        
        function filterBySizeClass(data, sizeClass) {
            // Filter data by Size_Class considering both formats
            if (!sizeClass) return data;
            return data.filter(row => matchSizeClass(row.Size_Class, sizeClass));
        }
        
        function filterTable(tableId, sizeClassFilter) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            // Get current size class filter if not provided
            if (sizeClassFilter === undefined) {
                const filterId = tableId.replace('Table', 'TableFilter');
                const filterContainer = document.getElementById(filterId);
                if (filterContainer) {
                    const activeBtn = filterContainer.querySelector('.table-filter-btn.active');
                    sizeClassFilter = activeBtn ? activeBtn.dataset.filter : '';
                } else {
                    sizeClassFilter = '';
                }
            }
            
            // Normalize the filter value
            const normalizedFilter = normalizeSizeClass(sizeClassFilter);
            
            // Get type filter
            const typeSelectorId = tableId.replace('Table', 'TypeSelector');
            const typeSelector = document.getElementById(typeSelectorId);
            let checkedTypes = [];
            if (typeSelector) {
                const checkboxes = typeSelector.querySelectorAll('input[type="checkbox"]');
                checkedTypes = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.dataset.type);
            }
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowSizeClass = row.dataset.sizeClass;
                const rowCountryType = row.dataset.countryType;
                
                // Check size class filter (normalize both for comparison)
                const normalizedRowSizeClass = normalizeSizeClass(rowSizeClass);
                const matchSizeClass = !normalizedFilter || normalizedRowSizeClass === normalizedFilter;
                
                // Check type filter
                const matchType = checkedTypes.length === 0 || checkedTypes.includes(rowCountryType);
                
                // Both filters must match
                if (matchSizeClass && matchType) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function filterTableByType(tableId) {
            // Re-apply both filters
            filterTable(tableId, undefined);
        }
    </script>
</body>
</html>
